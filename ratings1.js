/*

Для получения данных с кинопоиск используется https://kinopoiskapiunofficial.tech/ - получите API ключ 
Для получения данных Metacritic, Tomatoes, наград испольузется https://www.omdbapi.com/ - получите API ключ 

Можно использовать одиночный ключ или массив ключей, после получения API ключей передайте их как массивы через:
    window.RATINGS_PLUGIN_TOKENS && window.RATINGS_PLUGIN_TOKENS.OMDB_API_KEYS
Или просто введите ниже в коде плагина:
    var OMDB_API_KEYS = (window.RATINGS_PLUGIN_TOKENS && window.RATINGS_PLUGIN_TOKENS.OMDB_API_KEYS) || ['YOU_KEY']; // api ключи массивом
    var KP_API_KEYS   = (window.RATINGS_PLUGIN_TOKENS && window.RATINGS_PLUGIN_TOKENS.KP_API_KEYS)   || ['YOU_KEY']; // api ключи массивом

Для получения данных о качестве используется jacred парсер, по умолчанию плагин настроен на получение адреса и ключа вашего введеного jacred,
вы можете изменить это в переменных:
    var JACRED_PROTOCOL = 'https://'; // Протокол JacRed
    var JACRED_URL = Lampa.Storage.get('jackett_url'); // Адрес JacRed для получения информации о карточках без протокола (jacred.xyz)
    var JACRED_API_KEY = Lampa.Storage.get('jackett_key'); // api ключ JacRed

*/

(function() {
    'use strict';

    var star_svg = '<svg viewBox="5 5 54 54" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="none" stroke="white" stroke-width="2" d="M32 18.7461L36.2922 27.4159L46.2682 28.6834L38.9675 35.3631L40.7895 44.8469L32 40.2489L23.2105 44.8469L25.0325 35.3631L17.7318 28.6834L27.7078 27.4159L32 18.7461ZM32 23.2539L29.0241 29.2648L22.2682 30.1231L27.2075 34.6424L25.9567 41.1531L32 37.9918L38.0433 41.1531L36.7925 34.6424L41.7318 30.1231L34.9759 29.2648L32 23.2539Z"/><path fill="none" stroke="white" stroke-width="2" d="M32 9C19.2975 9 9 19.2975 9 32C9 44.7025 19.2975 55 32 55C44.7025 55 55 44.7025 55 32C55 19.2975 44.7025 9 32 9ZM7 32C7 18.1929 18.1929 7 32 7C45.8071 7 57 18.1929 57 32C57 45.8071 45.8071 57 32 57C18.1929 57 7 45.8071 7 32Z"/></svg>';
    var avg_svg = '<svg width="64" height="64" viewBox="10 10 44 44" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M31.4517 11.3659C31.8429 10.7366 32.7589 10.7366 33.1501 11.3659L40.2946 22.8568C40.4323 23.0782 40.651 23.2371 40.9041 23.2996L54.0403 26.5435C54.7598 26.7212 55.0428 27.5923 54.5652 28.1589L45.8445 38.5045C45.6764 38.7039 45.5929 38.961 45.6117 39.221L46.5858 52.7168C46.6392 53.4559 45.8982 53.9942 45.2117 53.7151L32.6776 48.6182C32.4361 48.52 32.1657 48.52 31.9242 48.6182L19.39 53.7151C18.7036 53.9942 17.9626 53.4559 18.016 52.7168L18.9901 39.221C19.0089 38.961 18.9253 38.7039 18.7573 38.5045L10.0366 28.1589C9.559 27.5923 9.84204 26.7212 10.5615 26.5435L23.6977 23.2996C23.9508 23.2371 24.1695 23.0782 24.3072 22.8568L31.4517 11.3659Z" fill="#FFDF6D"/><path fill-rule="evenodd" clip-rule="evenodd" d="M30.6024 10.8379C31.385 9.57926 33.2168 9.57926 33.9994 10.8379L41.1438 22.3288L54.2801 25.5727C55.7189 25.928 56.285 27.6702 55.3298 28.8034L46.6091 39.149L47.5832 52.6448C47.6899 54.123 46.208 55.1997 44.8351 54.6414L32.3009 49.5445L19.7667 54.6414C18.3938 55.1997 16.9118 54.123 17.0185 52.6448L17.9927 39.149L9.272 28.8034C8.3168 27.6702 8.88287 25.928 10.3217 25.5727L23.4579 22.3288L30.6024 10.8379ZM39.4454 23.3848L32.3009 11.8939L25.1564 23.3848C24.8811 23.8276 24.4437 24.1454 23.9374 24.2704L10.8012 27.5144L19.5219 37.86C19.858 38.2587 20.0251 38.7729 19.9875 39.293L19.0134 52.7888L31.5475 47.6919C32.0306 47.4954 32.5712 47.4954 33.0543 47.6919L45.5884 52.7888L44.6143 39.293C44.5767 38.7729 44.7438 38.2587 45.0799 37.86L53.8006 27.5144L40.6643 24.2704C40.1581 24.1454 39.7207 23.8276 39.4454 23.3848Z" fill="black"/></svg>';
    var oscars_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="255" height="255" viewBox="0 0 255 255">  <g transform="translate(77.561474, 0)">    <path      fill="#f0c60b"      d="M 2.2993819,243.56494 C -1.1026591,241.60427 -0.9385111,241.52608 4.2015339,240.00521 L 8.0440949,239.03157 L 8.2617039,226.55609 C 8.2617039,226.55609 11.280223,225.67709 12.312216,225.53163 C 14.427728,225.23345 19.775685,224.14614 24.36752,223.70487 C 28.959355,223.26362 33.61375,223.36451 33.61375,223.36451 C 35.705809,217.55816 35.821325,205.39069 32.708355,191.27168 C 31.382336,185.25747 31.024339,182.15035 31.881607,170.34849 C 32.785302,157.90746 32.369435,156.25117 30.366705,149.83556 C 28.541293,143.98797 27.847485,140.74011 27.857558,129.73289 C 27.864165,122.51234 28.704973,114.4525 29.305577,111.82215 C 30.637862,105.98738 29.322662,102.61956 24.601519,99.776463 C 19.225421,96.538956 17.369413,91.741154 17.621345,81.732632 C 17.78083,75.396835 17.297536,71.093691 15.794836,65.469737 C 13.38634,56.455791 13.82,52.944489 17.616516,50.719769 C 19.063909,49.871611 24.769691,47.179405 30.296033,44.737088 C 37.409114,41.593526 40.624681,39.697365 41.305143,38.245219 C 41.992829,36.77765 42.203737,33.867969 40.57434,28.286206 C 36.592772,14.6467 40.081451,9.2361905 49.839332,9.2361905 C 59.597214,9.2361905 63.429892,14.937624 59.104325,28.286206 C 57.307519,33.831098 57.685835,36.77765 58.373522,38.245219 C 59.053984,39.697365 62.269551,41.593526 69.382633,44.737088 C 74.908976,47.179405 80.614757,49.871611 82.062147,50.719769 C 85.858667,52.944489 86.292317,56.455791 83.883817,65.469737 C 82.381127,71.093691 81.897837,75.396835 82.057317,81.732632 C 82.309247,91.741154 80.453237,96.538956 75.077146,99.776463 C 70.356003,102.61956 69.040803,105.98738 70.37309,111.82215 C 70.973696,114.4525 71.642498,122.36687 71.649112,129.58743 C 71.659183,140.59465 71.13737,143.98797 69.31196,149.83556 C 67.30923,156.25117 66.864688,157.90897 67.797062,170.34849 C 68.684958,182.19476 68.501242,184.26188 66.769075,191.68194 C 64.685501,200.60734 63.581512,219.60387 66.780486,223.03797 C 66.780486,223.03797 70.720195,223.2637 75.311719,223.70493 C 79.903235,224.14616 85.331807,224.95806 87.366447,225.53163 C 88.914437,225.96802 91.244957,226.70155 91.244957,226.70155 L 91.634577,239.03157 L 95.477127,240.00521 C 100.78918,241.52608 101.12532,241.74973 97.379277,243.56494 C 95.489707,244.48057 95.782867,244.4595 95.782867,244.4595 C 95.782867,244.4595 3.1991929,244.08353 2.2993819,243.56494 z"    />  </g></svg>';
    var emmy_svg = '<svg   xmlns:dc="http://purl.org/dc/elements/1.1/"   xmlns:cc="http://creativecommons.org/ns#"   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"   xmlns:svg="http://www.w3.org/2000/svg"   xmlns="http://www.w3.org/2000/svg"   id="svg2"   version="1.1"   width="321"   height="563.40002"   viewBox="0 0 321 563.40002">  <metadata     id="metadata8">    <rdf:RDF>      <cc:Work         rdf:about="">        <dc:format>image/svg+xml</dc:format>        <dc:type           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />        <dc:title></dc:title>      </cc:Work>    </rdf:RDF>  </metadata>  <defs     id="defs6" />  <path     style="fill:#ffea55;fill-opacity:1"     d="m 74.000736,558.45002 c 1.419168,-2.3925 5.869572,-9.89926 9.889782,-16.68169 L 91.2,529.43665 l 0,-18.11832 0,-18.11831 -1.5,0 c -1.314288,0 -1.5,-0.26 -1.5,-2.1 0,-1.82704 0.19056,-2.1 1.466076,-2.1 1.000278,0 1.810464,-0.58445 2.55,-1.83952 3.29883,-5.59841 17.748674,-11.01359 38.883924,-14.57201 15.07121,-2.53745 37.2238,-4.57025 49.93857,-4.58254 5.8672,-0.005 6.15295,-0.0656 6.464,-1.35593 0.179,-0.7425 1.38764,-6.21 2.68589,-12.15 l 2.36044,-10.8 -46.25496,-91.20001 C 127.98142,314.71219 106.27409,279.9457 92.962182,240.13737 88.114902,225.64192 85.404036,218.40266 84.357492,217.15891 82.493382,214.94354 81,210.15143 81,206.38504 c 0,-5.79136 3.886722,-13.68528 8.810394,-17.89391 l 2.666022,-2.27885 -8.333772,-26.65613 -8.333772,-26.65614 -10.754436,-0.37312 C 53.657564,132.13147 49.166702,131.30278 41.468017,128.17453 22.562277,120.49244 8.0414946,103.83674 2.5403311,83.523501 1.1083157,78.235737 0.9617808,76.678893 0.9474399,66.600014 0.93373098,56.965242 1.1077609,54.853206 2.2658231,50.600046 2.9996204,47.905064 3.6,45.051569 3.6,44.258946 3.6,41.308294 5.4985663,36.582977 7.807899,33.785964 9.1184184,32.198691 11.635303,29.010013 13.400976,26.700013 20.094714,17.94271 28.752256,10.929783 38.626436,6.2664654 48.028435,1.8261454 60.505212,-0.52607559 70.79076,0.20258241 76.76664,0.62593341 86.32782,3.2953864 92.701692,6.3200484 102.87171,11.14614 113.28506,20.061692 118.8,28.664521 c 1.78694,2.787483 3.5116,4.67981 5.1,5.595822 3.51801,2.028802 7.6379,6.4128 9.24688,9.839671 1.75952,3.747478 2.23256,9.138201 1.21206,13.812412 -0.43079,1.973174 -0.71217,4.93847 -0.62528,6.58955 0.12527,2.380278 -0.21942,3.719412 -1.66441,6.466381 -1.00231,1.905438 -2.12118,5.14455 -2.48637,7.198044 -1.56897,8.822442 -6.36005,20.95421 -10.33833,26.178259 -7.19039,9.44201 -17.57346,18.27858 -26.09455,22.20792 -1.7325,0.7989 -3.15,1.70018 -3.15,2.00283 0,1.30926 6.725634,21.75143 7.266342,22.08561 0.328836,0.20323 3.025728,4.52965 5.993098,9.61425 2.96737,5.08461 5.21821,8.50047 5.00185,7.5908 -1.03039,-4.3324 2.61944,-9.94923 8.35301,-12.85465 3.57477,-1.81147 9.37776,-2.48312 12.51324,-1.44832 1.87057,0.61734 2.45623,0.51503 5.3368,-0.93229 3.76508,-1.89173 10.6449,-2.57282 14.75838,-1.46106 2.8436,0.76855 5.8258,3.0433 7.41437,5.6555 1.14042,1.87525 9.0202,7.20659 9.62248,6.5104 0.19776,-0.2286 3.81209,-9.32563 8.03185,-20.21563 4.21976,-10.89001 7.78403,-19.99869 7.92061,-20.24153 0.13657,-0.24284 2.42268,0.65172 5.08023,1.98791 2.65755,1.33619 4.89397,2.34488 4.96982,2.24153 0.0759,-0.10336 7.19655,-12.75012 15.82378,-28.103909 8.62723,-15.353798 16.10334,-28.448798 16.61356,-29.100003 0.87677,-1.119006 0.91035,-1.068726 0.61169,0.915997 -0.17381,1.155 -2.21522,17.085 -4.53647,35.399995 -2.32125,18.315 -4.34836,33.8998 -4.50469,34.63289 -0.27243,1.27758 -0.50632,1.1982 -5.6375,-1.91321 l -5.35327,-3.24608 -0.32876,1.6132 c -0.18082,0.88726 -1.68957,11.04664 -3.35278,22.57639 -1.6632,11.52975 -3.16447,21.10365 -3.33615,21.27532 -0.17167,0.17168 -3.40574,-1.22777 -7.18681,-3.10989 -3.78107,-1.88211 -6.87643,-3.22101 -6.87856,-2.97532 -0.013,1.48955 -6.65991,47.21048 -6.89817,47.44875 -0.3262,0.32619 -2.27277,-0.69903 -14.39795,-7.58319 l -8.4,-4.76916 -7.35462,21.97515 c -4.04504,12.08633 -7.5017,22.43494 -7.68146,22.9969 -0.23954,0.7488 0.35068,1.36741 2.20939,2.31565 5.18677,2.64609 11.9275,10.8995 15.86876,19.42983 3.80532,8.23611 5.71185,17.96715 4.53225,23.13277 l -0.61656,2.7 14.51728,28.65811 c 10.78048,21.28139 14.73986,28.57269 15.38193,28.3263 0.84644,-0.3248 57.65033,20.07553 57.6355,20.699 -0.004,0.17412 -8.91414,10.03482 -19.8,21.91264 L 209.4,423.89211 l 0,21.96294 0,21.96295 8.85,0.40375 c 40.55234,1.85009 72.41453,8.97829 80.33073,17.97156 1.76176,2.00147 2.92223,2.80671 4.04491,2.80671 1.39927,0 1.57436,0.23355 1.57436,2.1 0,1.93333 -0.14286,2.1 -1.8,2.1 l -1.8,0 0,17.63244 0,17.63245 9.06443,15.21756 c 4.98543,8.36965 9.59746,16.09505 10.24893,17.16755 l 1.18451,1.95 -124.83872,0 -124.83872,0 z M 73.597602,127.00241 c 0.164172,-0.16417 -0.951516,-4.24865 -2.479314,-9.07661 -3.48879,-11.02485 -2.959782,-10.6958 -15.497704,-9.63975 -6.652075,0.5603 -6.449345,0.20293 -3.241462,5.71396 2.950134,5.06823 9.088502,10.96353 13.020878,12.50526 2.98059,1.16858 7.266258,1.42848 8.197602,0.49714 z M 53.618794,123.41898 C 51.683457,121.3394 49.155,117.96324 48,115.9164 c -4.492639,-7.96169 -3.856145,-7.31639 -7.216476,-7.31639 -7.015931,0 -17.811365,-3.27057 -22.927374,-6.94606 l -2.971964,-2.135143 1.107907,1.923713 c 1.709693,2.96864 9.668443,11.21041 14.007907,14.50604 5.149935,3.91116 14.729887,8.53593 20.7,9.99304 2.64,0.64434 5.168457,1.19108 5.618794,1.21497 0.450336,0.0239 -0.764664,-1.65802 -2.7,-3.73759 z m 43.898534,-5.12175 c 2.960472,-1.92654 5.897612,-4.08719 6.526972,-4.80146 l 1.1443,-1.29865 -2.9443,0.39864 c -4.94824,0.66994 -5.425882,0.96919 -8.227012,5.15425 -1.490904,2.2275 -2.52441,4.05 -2.29668,4.05 0.227724,0 2.836248,-1.57625 5.79672,-3.50278 z m -8.07456,-2.04722 1.850298,-2.55 -1.696536,-0.37901 c -0.93309,-0.20845 -2.333298,-0.41095 -3.111576,-0.45 -1.213794,-0.0609 -1.362444,0.13858 -1.045212,1.40255 0.561312,2.23644 1.493034,4.52646 1.841646,4.52646 0.171096,0 1.14372,-1.1475 2.16138,-2.55 z m 6.337452,-12.75 c 1.034124,-2.64 2.053632,-5.549916 2.265576,-6.466494 l 0.38535,-1.666494 -3.465576,1.732644 c -1.906062,0.952956 -5.670276,2.605477 -8.364918,3.672264 l -4.899348,1.93962 0.636402,1.89423 c 0.350022,1.04183 0.888258,2.21724 1.196082,2.61202 0.59037,0.75715 3.954072,1.23887 7.966212,1.14085 l 2.4,-0.0586 1.88022,-4.8 z m 12.89798,2.31662 c 4.16453,-1.86893 7.26138,-5.06592 9.37106,-9.674066 1.30961,-2.86056 1.46545,-3.85032 1.16691,-7.411297 -0.48858,-5.827734 -0.87483,-6.331002 -3.45027,-4.495602 -1.13624,0.809748 -4.16882,2.910492 -6.73905,4.668312 -3.19353,2.184103 -4.77647,3.670975 -4.99945,4.696039 -0.30776,1.414752 -3.55796,11.799704 -4.290162,13.707794 -0.508026,1.32389 4.546642,0.48087 8.940962,-1.49118 z M 42,103.39258 C 42,103.1685 41.422081,101.211 40.715736,99.042587 39.465596,95.204776 39.29675,95.005234 34.361241,91.532956 31.059647,89.210181 27.20339,87.178161 23.306333,85.707681 20.01476,84.465663 16.394282,82.876317 15.260827,82.175805 L 13.2,80.902143 l 0,2.973498 c 0,9.575389 7.306675,16.390069 20.4,19.026369 4.348796,0.87561 8.4,1.11221 8.4,0.49057 z m 12.55,0.17777 c -0.1375,-0.12632 -2.213885,-1.21293 -4.614189,-2.41469 l -4.36419,-2.185019 0.91419,2.187959 c 0.502804,1.20338 0.914189,2.28999 0.914189,2.41469 0,0.1247 1.665,0.22672 3.7,0.22672 2.035,0 3.5875,-0.10335 3.45,-0.22966 z m 11.133638,-2.82188 C 65.465166,100.06012 64.623852,98.0497 63.81405,96.280864 62.169456,92.688586 62.63472,92.86477 52.8,92.110228 50.325,91.92034 47.2875,91.603354 46.05,91.405816 c -1.2375,-0.197544 -2.249929,-0.12216 -2.249843,0.167514 2.07e-4,0.690012 9.944647,6.26136 15.299843,8.5717 5.157894,2.22521 7.156512,2.40841 6.583638,0.60344 z m 26.266704,-7.87626 c 2.887686,-1.35933 5.164188,-2.557662 5.058894,-2.662962 -0.1053,-0.105294 -2.352162,0.188448 -4.993038,0.652758 -2.64087,0.46431 -6.746778,1.035876 -9.124236,1.270146 -4.714452,0.46455 -4.553826,0.235608 -3.027654,4.315338 l 0.504072,1.34748 3.16581,-1.225626 C 85.275384,95.89525 89.062656,94.23154 91.950342,92.87221 Z M 59.4,86.712279 c 0,-0.158256 -1.218128,-3.035124 -2.70695,-6.393048 -1.488823,-3.357924 -2.601032,-6.211236 -2.471576,-6.340692 0.371589,-0.371586 19.254034,-5.446765 19.491562,-5.238895 0.117168,0.102546 0.580134,3.342619 1.028802,7.200169 0.448674,3.85755 1.12674,7.955976 1.50681,9.10761 l 0.691044,2.09388 4.280154,-0.392502 c 4.532112,-0.415602 19.130614,-2.714556 19.495864,-3.070188 0.5477,-0.533262 1.23411,-9.728808 1.25794,-16.852183 L 102,58.952846 99.45,56.615549 C 96.087768,53.53377 90.737862,49.473434 85.256142,45.84305 L 80.812284,42.900014 66.956142,42.918984 53.1,42.937954 48.173979,45.463622 c -2.709312,1.389117 -5.253173,3.13558 -5.653024,3.881028 -1.651033,3.07804 -1.234923,34.207515 0.479682,35.885265 C 43.85755,86.068407 59.4,87.473313 59.4,86.712279 Z m -51.7458018,-9.7599 c -0.6924114,-0.741198 -1.358835,-1.24773 -1.4809416,-1.125618 -0.122106,0.122106 0.2466648,2.213538 0.8194914,4.64763 l 1.0415034,4.425624 0.4394382,-3.3 c 0.383463,-2.879646 0.2790768,-3.47166 -0.8194914,-4.647636 z M 36.967956,81.150015 C 36.220288,75.757533 35.915551,62.0921 36.433634,57.189177 l 0.51892,-4.910837 -1.670633,0.986868 C 30.06717,56.345637 18.6,67.764806 18.6,69.877298 c 0,0.475296 2.707357,3.571537 6.01635,6.880531 5.844072,5.844072 7.747457,7.05321 11.315204,7.188072 1.368041,0.05172 1.414023,-0.07233 1.036402,-2.795886 z m 86.952124,-1.229922 c -0.67055,-0.670548 -1.31987,0.654192 -1.03695,2.1156 l 0.32218,1.664322 0.47751,-1.769838 c 0.26262,-0.973416 0.36939,-1.877952 0.23726,-2.010084 z m -8.80082,-1.582188 c 0.86586,-0.86586 0.81879,-1.18863 -0.53493,-3.668358 -0.81639,-1.495428 -2.74337,-4.346227 -4.2822,-6.335107 l -2.79787,-3.616146 -0.32949,3.79086 c -0.18122,2.084977 -0.48081,6.016129 -0.66575,8.735899 l -0.33627,4.945038 3.99855,-1.451394 c 2.19921,-0.79827 4.42579,-1.87863 4.94796,-2.400792 z M 17.606163,76.538409 C 16.085444,74.632551 15,74.260137 15,75.644247 c 0,0.46344 3.424598,2.945208 4.075579,2.953524 0.09657,0.0012 -0.564669,-0.925482 -1.469416,-2.059362 z M 123.30724,69.590156 c 1.83247,-2.49633 2.09174,-3.288666 2.08457,-6.37053 -0.005,-1.935786 -0.16555,-4.106255 -0.35786,-4.823263 -0.65923,-2.45778 -8.17011,-6.985684 -16.32784,-9.843165 l -3.1939,-1.118753 0.3053,1.632785 c 0.16791,0.898031 0.48121,2.982784 0.69624,4.632784 0.31362,2.40662 0.94811,3.652718 3.20784,6.3 4.11241,4.817736 6.28209,7.73649 8.1528,10.967593 1.896,3.274764 2.04566,3.23682 5.43285,-1.377451 z M 11.857292,71.173617 c 0.361173,-0.792691 0.421663,-1.659019 0.136154,-1.950001 -0.282566,-0.287982 -1.463912,-2.106504 -2.6252134,-4.041162 -2.0476194,-3.41121 -2.1237648,-3.468522 -2.5185318,-1.895646 -0.5000616,1.992402 0.5272896,5.613606 2.1935922,7.731967 1.532362,1.948086 1.985581,1.973022 2.813999,0.154842 z M 29.949688,51.126512 c 2.512717,-1.884574 5.239467,-3.888428 6.059444,-4.453008 L 37.5,45.646994 35.4,46.006906 c -6.898507,1.18231 -18.824066,6.14374 -23.371664,9.723389 -1.643183,1.293435 -1.523811,1.844676 1.54236,7.122383 l 1.483012,2.552664 5.163702,-5.426165 c 2.840037,-2.984392 7.219562,-6.968092 9.732278,-8.852665 z m 99.702432,-1.626498 c -0.36914,-1.65 -1.23536,-3.81 -1.92493,-4.8 -0.7092,-1.018188 -1.07085,-1.278792 -0.83263,-0.6 0.23162,0.66 1.0026,3.495 1.71329,6.3 1.378,5.438863 2.28712,4.655345 1.04427,-0.9 z M 17.153952,46.89582 c 4.957223,-2.46424 14.655736,-5.795343 18.804848,-6.458813 1.3302,-0.212707 2.647378,-0.690548 2.927062,-1.061867 0.698473,-0.92732 3.248783,-10.040481 2.905803,-10.383462 -0.152176,-0.152176 -3.475054,-0.283378 -7.384174,-0.29156 -7.651373,-0.01601 -11.333457,0.64392 -16.213939,2.906006 -3.460401,1.603884 -4.997996,3.72959 -8.048327,11.126721 -1.7389676,4.217039 -2.0712716,6.119361 -1.3824944,7.914285 0.320034,0.833996 0.5559162,0.8077 2.0039524,-0.223392 0.902671,-0.642759 3.776943,-2.230322 6.387269,-3.527918 z m 83.632688,2.23114 c -0.24873,-1.360181 -0.814448,-2.69692 -1.257164,-2.970531 -0.968118,-0.598331 -5.305668,-1.380226 -5.66475,-1.021139 -0.178554,0.178549 6.311604,5.888954 7.304714,6.427098 0.0382,0.02069 -0.13407,-1.075249 -0.3828,-2.435428 z m 22.00675,-1.109994 c -0.19613,-0.980676 -1.33947,-3.933197 -2.54074,-6.561157 -1.88729,-4.128725 -2.48099,-4.896258 -4.36839,-5.647441 -3.41868,-1.360631 -13.27999,-3.082653 -13.2893,-2.320632 -0.003,0.226752 0.44972,2.187003 1.00555,4.356113 l 1.01058,3.943835 4.84446,1.646893 c 2.66445,0.905791 6.73445,2.675373 9.04445,3.932405 2.31,1.257033 4.30125,2.318705 4.425,2.359273 0.12375,0.04057 0.0645,-0.728613 -0.13161,-1.709289 z M 99,39.708914 c 0,-0.270104 -0.427002,-1.928973 -0.948894,-3.686375 l -0.948894,-3.195276 -5.341998,0.379186 C 85.436436,33.655324 78,34.8184 78,35.358579 c 0,0.81428 3.58269,2.444224 5.492574,2.498845 1.104084,0.03158 4.572426,0.532304 7.707426,1.11273 6.938106,1.284546 7.8,1.366179 7.8,0.73876 z M 57.45,35.969058 c 2.0625,-0.804614 3.75,-1.624252 3.75,-1.821416 0,-0.381459 -9.260642,-3.310091 -12.324685,-3.89762 -1.919126,-0.367992 -2.07168,-0.09369 -4.226313,7.599119 -0.237612,0.848357 0.228758,0.876597 4.392581,0.26599 C 51.603712,37.739406 55.3875,36.773673 57.45,35.969058 Z m 16.399212,-5.081797 c 4.451802,-1.153578 14.972268,-2.661836 18.667536,-2.676256 l 2.816748,-0.01099 -1.269084,-3.053759 c -0.76542,-1.841814 -1.786824,-3.250605 -2.57364,-3.549752 -3.970716,-2.536441 -3.593171,-6.95089 -6.066048,-9.614896 C 81.937596,8.2535874 77.6994,6.1933604 72.429198,5.6643664 68.65143,5.2851744 68.08161,5.3920234 64.513272,7.1487104 59.768832,9.4843914 54.461406,15.06302 51.349325,20.985321 l -2.185355,4.158737 2.568015,0.669534 c 5.766268,1.503384 10.568421,3.030439 13.970715,4.442599 4.324338,1.794865 3.809262,1.754965 8.146512,0.63107 z M 113.4,29.631485 c 0,-0.966017 -6.77573,-8.027747 -10.68902,-11.140196 -4.876984,-3.878925 -7.591438,-5.591517 -6.212422,-3.919522 0.439206,0.532519 0.724572,1.859223 0.634146,2.948232 -0.09544,1.149441 0.576324,3.801644 1.601442,6.322621 1.704014,4.190532 1.839394,4.345133 3.865854,4.414761 1.155,0.03968 3.855,0.409257 6,0.821271 2.145,0.412014 4.1025,0.787871 4.35,0.835238 0.2475,0.04737 0.45,-0.07972 0.45,-0.282405 z M 28.697959,24.029337 C 31.628286,23.707393 36.127153,23.66645 39,23.935587 c 2.805,0.262776 5.122294,0.452272 5.149541,0.421103 0.02725,-0.03117 1.188954,-2.196242 2.58157,-4.81127 2.549783,-4.787939 7.7152,-11.7954176 9.569256,-12.9817926 1.824302,-1.167336 -4.011242,-0.02179 -9.992638,1.961605 -6.400489,2.1223636 -13.264604,6.0307176 -19.38343,11.0367196 -4.259202,3.484585 -6.495989,6.216072 -4.44614,5.429471 0.559768,-0.214803 3.358678,-0.64774 6.2198,-0.962086 z M 93.6,12.364207 c 0,-0.129694 -0.405,-0.39122 -0.9,-0.581169 -0.495,-0.18995 -0.9,-0.08384 -0.9,0.235806 0,0.319643 0.405,0.581169 0.9,0.581169 0.495,0 0.9,-0.106113 0.9,-0.235806 z"     id="path4144" />  <rect     y="493.01883"     x="91.434082"     height="35.565834"     width="209.03105"     id="rect4134"     style="opacity:1;fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.60000002;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" /></svg>';
    var awards_svg = '<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512.001 512.001" style="enable-background:new 0 0 512.001 512.001;" xml:space="preserve"><path style="fill:#F9AC30;" d="M227.117,383.98h-46.308c-16.987,0-30.758,13.771-30.758,30.758v34.25h211.906v-34.25 c0-16.987-13.771-30.758-30.758-30.758h-46.308H227.117z"></path><path style="fill:#DD8D19;" d="M491.157,70.23c-15.917-24.944-43.818-38.67-78.545-38.67h-0.902H100.3h-0.902 c-34.738,0-62.628,13.725-78.545,38.67c-17.196,26.947-17.636,62.691-1.206,98.089c30.197,65.029,125.456,86.713,129.503,87.604 l9.269,2.045h0.01H353.57h0.01l9.279-2.045c4.037-0.891,99.306-22.575,129.493-87.604C508.783,132.921,508.343,97.177,491.157,70.23 z M463.822,155.066c-12.1,26.056-40.379,43.671-61.978,53.852c-8.912,4.205-17.395,7.497-24.577,9.992l-242.523,0.01h-0.01 c-7.193-2.506-15.675-5.798-24.577-10.003c-21.589-10.181-49.878-27.796-61.978-53.852c-11.817-25.448-12.11-50.203-0.807-67.913 c9.93-15.571,28.415-24.137,52.028-24.137h0.933h311.348h0.933c23.613,0,42.088,8.566,52.028,24.137 C475.933,104.863,475.639,129.618,463.822,155.066z"></path><path style="fill:#F9AC30;" d="M278.024,383.98l-0.047-30.532c-0.034-21.96,11.352-42.511,30.284-53.637 c60.287-35.43,103.444-130.412,103.444-242.04V0H100.297v57.769c0,111.63,43.159,206.615,103.448,242.042 c18.931,11.125,30.317,31.675,30.284,53.633l-0.045,30.535l25.164,26.053L278.024,383.98z"></path><g><path style="fill:#DD8D19;" d="M245.486,353.447l-0.021,30.533h-11.481l0.042-30.533c0.031-21.956-11.356-42.507-30.281-53.632 c-60.29-35.43-103.447-130.415-103.447-242.041V0h81.198v57.774c0,111.626,20.656,206.611,49.501,242.041 C240.055,310.939,245.507,331.49,245.486,353.447z"></path><path style="fill:#DD8D19;" d="M247.916,383.98h-20.797H180.81c-16.987,0-30.758,13.771-30.758,30.758v34.25h67.105v-34.25 C217.157,397.751,230.928,383.98,247.916,383.98z"></path></g><path style="fill:#4F5B5E;" d="M219.114,432.212h-80.945c-9.652,0-17.476,7.824-17.476,17.476v62.314h270.624v-62.314 c0-9.652-7.824-17.476-17.476-17.476h-80.945"></path><path style="fill:#3B4547;" d="M159.138,432.212h-20.97c-9.652,0-17.476,7.824-17.476,17.476v62.314h20.97v-62.314 C141.664,440.036,149.487,432.212,159.138,432.212z"></path></svg>';    
    var tmdb_svg = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 200 70"><defs><linearGradient id="linear-gradient" x1="20" y1="37.5" x2="180" y2="37.5" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#90cea1"/><stop offset="0.56" stop-color="#3cbec9"/><stop offset="1" stop-color="#00b3e5"/></linearGradient></defs><!-- Темный фон с выступами по бокам --><rect width="100%" height="100%" rx="10" fill="#152e42"/><!-- Градиентный текст логотипа со смещением от краев --><path fill="url(#linear-gradient)" transform="translate(20, 17)" d="M10.1,35.42h7.8V6.92H28V0H0v6.9H10.1Zm28.1,0H46V8.25h.1L55.05,35.4h6L70.3,8.25h.1V35.4h7.8V0H66.45l-8.2,23.1h-.1L50,0H38.2ZM89.14.12h11.7a33.56,33.56,0,0,1,8.08,1,18.52,18.52,0,0,1,6.67,3.08,15.09,15.09,0,0,1,4.53,5.52,18.5,18.5,0,0,1,1.67,8.25,16.91,16.91,0,0,1-1.62,7.58,16.3,16.3,0,0,1-4.38,5.5,19.24,19.24,0,0,1-6.35,3.37,24.53,24.53,0,0,1-7.55,1.15H89.14Zm7.8,28.2h4a21.66,21.66,0,0,0,5-.55A10.58,10.58,0,0,0,110,26a8.73,8.73,0,0,0,2.68-3.35,11.9,11.9,0,0,0,1-5.08,9.87,9.87,0,0,0-1-4.52,9.17,9.17,0,0,0-2.63-3.18A11.61,11.61,0,0,0,106.22,8a17.06,17.06,0,0,0-4.68-.63h-4.6ZM133.09.12h13.2a32.87,32.87,0,0,1,4.63.33,12.66,12.66,0,0,1,4.17,1.3,7.94,7.94,0,0,1,3,2.72,8.34,8.34,0,0,1,1.15,4.65,7.48,7.48,0,0,1-1.67,5,9.13,9.13,0,0,1-4.43,2.82V17a10.28,10.28,0,0,1,3.18,1,8.51,8.51,0,0,1,2.45,1.85,7.79,7.79,0,0,1,1.57,2.62,9.16,9.16,0,0,1,.55,3.2,8.52,8.52,0,0,1-1.2,4.68,9.32,9.32,0,0,1-3.1,3A13.38,13.38,0,0,1,152.32,35a22.5,22.5,0,0,1-4.73.5h-14.5Zm7.8,14.15h5.65a7.65,7.65,0,0,0,1.78-.2,4.78,4.78,0,0,0,1.57-.65,3.43,3.43,0,0,0,1.13-1.2,3.63,3.63,0,0,0,.42-1.8A3.3,3.3,0,0,0,151,8.6a3.42,3.42,0,0,0-1.23-1.13A6.07,6.07,0,0,0,148,6.9a9.9,9.9,0,0,0-1.85-.18h-5.3Zm0,14.65h7a8.27,8.27,0,0,0,1.83-.2,4.67,4.67,0,0,0,1.67-.7,3.93,3.93,0,0,0,1.23-1.3,3.8,3.8,0,0,0,.47-1.95,3.16,3.16,0,0,0-.62-2,4,4,0,0,0-1.58-1.18,8.23,8.23,0,0,0-2-.55,15.12,15.12,0,0,0-2.05-.15h-5.9Z"/></svg>';
    var imdb_svg = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet" viewBox="0 0 575 289.83" width="575" height="289.83"><defs><path d="M575 24.91C573.44 12.15 563.97 1.98 551.91 0C499.05 0 76.18 0 23.32 0C10.11 2.17 0 14.16 0 28.61C0 51.84 0 237.64 0 260.86C0 276.86 12.37 289.83 27.64 289.83C79.63 289.83 495.6 289.83 547.59 289.83C561.65 289.83 573.26 278.82 575 264.57C575 216.64 575 48.87 575 24.91Z" id="d1pwhf9wy2"></path><path d="M69.35 58.24L114.98 58.24L114.98 233.89L69.35 233.89L69.35 58.24Z" id="g5jjnq26yS"></path><path d="M201.2 139.15C197.28 112.38 195.1 97.5 194.67 94.53C192.76 80.2 190.94 67.73 189.2 57.09C185.25 57.09 165.54 57.09 130.04 57.09L130.04 232.74L170.01 232.74L170.15 116.76L186.97 232.74L215.44 232.74L231.39 114.18L231.54 232.74L271.38 232.74L271.38 57.09L211.77 57.09L201.2 139.15Z" id="i3Prh1JpXt"></path><path d="M346.71 93.63C347.21 95.87 347.47 100.95 347.47 108.89C347.47 115.7 347.47 170.18 347.47 176.99C347.47 188.68 346.71 195.84 345.2 198.48C343.68 201.12 339.64 202.43 333.09 202.43C333.09 190.9 333.09 98.66 333.09 87.13C338.06 87.13 341.45 87.66 343.25 88.7C345.05 89.75 346.21 91.39 346.71 93.63ZM367.32 230.95C372.75 229.76 377.31 227.66 381.01 224.67C384.7 221.67 387.29 217.52 388.77 212.21C390.26 206.91 391.14 196.38 391.14 180.63C391.14 174.47 391.14 125.12 391.14 118.95C391.14 102.33 390.49 91.19 389.48 85.53C388.46 79.86 385.93 74.71 381.88 70.09C377.82 65.47 371.9 62.15 364.12 60.13C356.33 58.11 343.63 57.09 321.54 57.09C319.27 57.09 307.93 57.09 287.5 57.09L287.5 232.74L342.78 232.74C355.52 232.34 363.7 231.75 367.32 230.95Z" id="a4ov9rRGQm"></path><path d="M464.76 204.7C463.92 206.93 460.24 208.06 457.46 208.06C454.74 208.06 452.93 206.98 452.01 204.81C451.09 202.65 450.64 197.72 450.64 190C450.64 185.36 450.64 148.22 450.64 143.58C450.64 135.58 451.04 130.59 451.85 128.6C452.65 126.63 454.41 125.63 457.13 125.63C459.91 125.63 463.64 126.76 464.6 129.03C465.55 131.3 466.03 136.15 466.03 143.58C466.03 146.58 466.03 161.58 466.03 188.59C465.74 197.84 465.32 203.21 464.76 204.7ZM406.68 231.21L447.76 231.21C449.47 224.5 450.41 220.77 450.6 220.02C454.32 224.52 458.41 227.9 462.9 230.14C467.37 232.39 474.06 233.51 479.24 233.51C486.45 233.51 492.67 231.62 497.92 227.83C503.16 224.05 506.5 219.57 507.92 214.42C509.34 209.26 510.05 201.42 510.05 190.88C510.05 185.95 510.05 146.53 510.05 141.6C510.05 131 509.81 124.08 509.34 120.83C508.87 117.58 507.47 114.27 505.14 110.88C502.81 107.49 499.42 104.86 494.98 102.98C490.54 101.1 485.3 100.16 479.26 100.16C474.01 100.16 467.29 101.21 462.81 103.28C458.34 105.35 454.28 108.49 450.64 112.7C450.64 108.89 450.64 89.85 450.64 55.56L406.68 55.56L406.68 231.21Z" id="fk968BpsX"></path></defs><g><g><g><use xlink:href="#d1pwhf9wy2" opacity="1" fill="#f6c700" fill-opacity="1"></use><g><use xlink:href="#d1pwhf9wy2" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#g5jjnq26yS" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#g5jjnq26yS" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#i3Prh1JpXt" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#i3Prh1JpXt" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#a4ov9rRGQm" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#a4ov9rRGQm" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#fk968BpsX" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#fk968BpsX" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g></g></g></svg>';
    var kp_svg = '<svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="120" height="120" fill="black"/><path d="M120 0L31.5771 47.3297L77.6571 0H52.1143L20.7429 43.5446V0H0V120H20.7429V76.5257L52.1143 120H77.6571L32.7737 74.1583L120 120V97.7143L40.4434 65.7977L120 71.1429V48.8571L40.9474 53.9966L120 22.2857V0Z" fill="url(#paint0_radial_4902_370)"/><defs><radialGradient id="paint0_radial_4902_370" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="rotate(45) scale(169.706)"><stop offset="0.5" stop-color="#FF5500"/><stop offset="1" stop-color="#BBFF00"/></radialGradient></defs></svg>';
    var lampa_svg = '<svg width="110" height="104" viewBox="0 0 110 104" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="53" cy="53" r="53" fill="black"/><path d="M81.6744 103.11C98.5682 93.7234 110 75.6967 110 55C110 24.6243 85.3757 0 55 0C24.6243 0 0 24.6243 0 55C0 75.6967 11.4318 93.7234 28.3255 103.11C14.8869 94.3724 6 79.224 6 62C6 34.938 27.938 13 55 13C82.062 13 104 34.938 104 62C104 79.224 95.1131 94.3725 81.6744 103.11Z" fill="white"/><path d="M92.9546 80.0076C95.5485 74.5501 97 68.4446 97 62C97 38.804 78.196 20 55 20C31.804 20 13 38.804 13 62C13 68.4446 14.4515 74.5501 17.0454 80.0076C16.3618 77.1161 16 74.1003 16 71C16 49.4609 33.4609 32 55 32C76.5391 32 94 49.4609 94 71C94 74.1003 93.6382 77.1161 92.9546 80.0076Z" fill="white"/><path d="M55 89C69.3594 89 81 77.3594 81 63C81 57.9297 79.5486 53.1983 77.0387 49.1987C82.579 54.7989 86 62.5 86 71C86 88.1208 72.1208 102 55 102C37.8792 102 24 88.1208 24 71C24 62.5 27.421 54.7989 32.9613 49.1987C30.4514 53.1983 29 57.9297 29 63C29 77.3594 40.6406 89 55 89Z" fill="white"/><path d="M73 63C73 72.9411 64.9411 81 55 81C45.0589 81 37 72.9411 37 63C37 53.0589 45.0589 45 55 45C64.9411 45 73 53.0589 73 63Z" fill="white"/></svg>';
    var bylampa_svg = '<svg width="32" height="32" viewBox="2 1 21 21" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="starGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ecc440"/><stop offset="25%" stop-color="#fffa8a"/><stop offset="50%" stop-color="#ddac17"/><stop offset="100%" stop-color="#ffff95"/></linearGradient><linearGradient id="shineGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ffff95" stop-opacity="0"><animate attributeName="stop-opacity" values="0;0.8;0" dur="4s" repeatCount="indefinite"/></stop><stop offset="50%" stop-color="#ffffff" stop-opacity="0"><animate attributeName="stop-opacity" values="0;1;0" dur="4s" repeatCount="indefinite" begin="0.5s"/></stop><stop offset="100%" stop-color="#fffa8a" stop-opacity="0"><animate attributeName="stop-opacity" values="0;0.6;0" dur="4s" repeatCount="indefinite" begin="1s"/></stop></linearGradient><filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter></defs><g transform="translate(12,12)"><g><animateTransform attributeName="transform" type="scale" values="1,1;0.05,1;1,1" dur="3s" repeatCount="indefinite" calcMode="spline" keyTimes="0;0.5;1" keySplines="0.4 0 0.2 1;0.4 0 0.2 1"/><path d="M0 -7L2.1 -2.1L7.5 -2.1L3.4 1L4.5 6.5L0 3.8L-4.5 6.5L-3.4 1L-7.5 -2.1L-2.1 -2.1L0 -7Z" fill="url(#starGradient)" stroke="#ddac17" stroke-width="0.5" filter="url(#glow)"/><path d="M0 -7L2.1 -2.1L7.5 -2.1L3.4 1L4.5 6.5L0 3.8L-4.5 6.5L-3.4 1L-7.5 -2.1L-2.1 -2.1L0 -7Z" fill="url(#shineGradient)" stroke="none"/></g></g></svg>';
    var rt_svg = '<svg id="svg3390" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="141.25" viewBox="0 0 138.75 141.25" width="138.75" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"> <metadata id="metadata3396">  <rdf:RDF>   <cc:Work rdf:about="">    <dc:format>image/svg+xml</dc:format>    <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>    <dc:title/>   </cc:Work>  </rdf:RDF> </metadata> <g id="layer1" fill="#f93208">  <path id="path3412" d="m20.154 40.829c-28.149 27.622-13.657 61.011-5.734 71.931 35.254 41.954 92.792 25.339 111.89-5.9071 4.7608-8.2027 22.554-53.467-23.976-78.009z"/>  <path id="path3471" d="m39.613 39.265 4.7778-8.8607 28.406-5.0384 11.119 9.2082z"/> </g> <g id="layer2">  <path id="path3437" d="m39.436 8.5696 8.9682-5.2826 6.7569 15.479c3.7925-6.3226 13.79-16.316 24.939-4.6684-4.7281 1.2636-7.5161 3.8553-7.7397 8.4768 15.145-4.1697 31.343 3.2127 33.539 9.0911-10.951-4.314-27.695 10.377-41.771 2.334 0.009 15.045-12.617 16.636-19.902 17.076 2.077-4.996 5.591-9.994 1.474-14.987-7.618 8.171-13.874 10.668-33.17 4.668 4.876-1.679 14.843-11.39 24.448-11.425-6.775-2.467-12.29-2.087-17.814-1.475 2.917-3.961 12.149-15.197 28.625-8.476z" fill="#02902e"/> </g></svg>';
    var mc_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88" viewBox="0 0 88 88"><circle fill="#001B36" stroke="#FC0" stroke-width="4.6" cx="44" cy="44" r="41.6"/><path transform="translate(-10,-961) matrix(1.2756629,-1.3487733,1.3685717,1.2634987,-267.04706,1066.0743)" fill="#FFF"d="m126.73438,92.087002 5.05859,0 0,2.832031 c 1.80989-2.200501 3.96483-3.30076 6.46484-3.300781 1.32811,2.1e-5 2.48045,.273458 3.45703,.820312 .97655,.546895 1.77733,1.373717 2.40235,2.480469 .91144-1.106752 1.89451-1.933574 2.94922-2.480469 1.05466-0.546854 2.18096-0.820291 3.3789-0.820312 1.52341,2.1e-5 2.81247,.309265 3.86719,.927734 1.05466,.618509 1.84242,1.526711 2.36328,2.724609 .37757,.885434 .56637,2.317724 .56641,4.296875 l 0,13.26172-5.48828,0 0-11.85547 c-3e-5-2.057277-0.18883-3.385401-0.56641-3.984375-0.50784-0.781233-1.28909-1.171858-2.34375-1.171875-0.76825,1.7e-5-1.49091,.234392-2.16797,.703125-0.6771,.468766-1.16538,1.155614-1.46484,2.060547-0.2995,.904961-0.44924,2.333998-0.44922,4.287108 l 0,9.96094-5.48828,0 0-11.36719 c-2e-5-2.018214-0.0977-3.320296-0.29297-3.906248-0.19533-0.585922-0.49806-1.02212-0.9082-1.308594-0.41017-0.286442-0.96681-0.429671-1.66993-0.429688-0.84636,1.7e-5-1.60808,.227882-2.28515,.683594-0.6771,.455745-1.16212,1.113297-1.45508,1.972656-0.29298,.859389-0.43946,2.28517-0.43945,4.27734 l 0,10.07813-5.48828,0z"/></svg>';
    
    Lampa.Lang.add({
         maxsm_ratings: {
            ru: 'Рейтинг и качество',
            en: 'Rating & Quality',
            uk: 'Рейтинг і якість',
            be: 'Рэйтынг і якасць',
            pt: 'Classificação e Qualidade',
            zh: '评分与画质',
            he: 'דירוג ואיכות',
                        cs: 'Hodnocení a kvalita',
            bg: 'Рейтинг и качество'
        },
        maxsm_ratings_cc: {
            ru: 'Очистить локальный кеш',
            en: 'Clear local cache',
            uk: 'Очистити локальний кеш',
            be: 'Ачысціць лакальны кэш',
            pt: 'Limpar cache local',
            zh: '清除本地缓存',
            he: 'נקה מטמון מקומי',
                        cs: 'Vymazat místní mezipaměť',
            bg: 'Изчистване на локалния кеш'
        },
        maxsm_ratings_critic: {
            ru: 'Оценки критиков',
            en: 'Critic Ratings',
            uk: 'Оцінки критиків',
            be: 'Ацэнкі крытыкаў',
            pt: 'Avaliações da crítica',
            zh: '影评人评分',
            he: 'דירוגי מבקרים',
                        cs: 'Hodnocení kritiků',
            bg: 'Оценки на критиците'
        },
        maxsm_ratings_mode: {
            ru: 'Средний рейтинг',
            en: 'Average rating',
            uk: 'Середній рейтинг',
            be: 'Сярэдні рэйтынг',
            pt: 'Classificação média',
            zh: '平均评分',
            he: 'דירוג ממוצע',
                        cs: 'Průměrné hodnocení',
            bg: 'Среден рейтинг'
        },
        maxsm_ratings_mode_normal: {
            ru: 'Показывать средний рейтинг',
            en: 'Show average rating',
            uk: 'Показувати середній рейтинг',
            be: 'Паказваць сярэдні рэйтынг',
            pt: 'Mostrar classificação média',
            zh: '显示平均评分',
            he: 'הצג דירוג ממוצע',
                        cs: 'Zobrazit průměrné hodnocení',
            bg: 'Показване на среден рейтинг'
        },
        maxsm_ratings_mode_simple: {
            ru: 'Только средний рейтинг',
            en: 'Only average rating',
            uk: 'Лише середній рейтинг',
            be: 'Толькі сярэдні рэйтынг',
            pt: 'Apenas classificação média',
            zh: '仅显示平均评分',
            he: 'רק דירוג ממוצע',
                        cs: 'Pouze průměrné hodnocení',
            bg: 'Само среден рейтинг'
        },
        maxsm_ratings_mode_noavg: {
            ru: 'Без среднего рейтинга',
            en: 'No average',
            uk: 'Без середнього рейтингу',
            be: 'Без сярэдняга рэйтынгу',
            pt: 'Sem média',
            zh: '无平均值',
            he: 'ללא ממוצע',
                        cs: 'Bez průměru',
            bg: 'Без среден рейтинг'
        }, 
        maxsm_ratings_icons: {
            ru: 'Значки',
            en: 'Icons',
            uk: 'Значки',
            be: 'Значкі',
            pt: 'Ícones',
            zh: '图标',
            he: 'סמלים',
                        cs: 'Ikony',
            bg: 'Икони'
        },
        maxsm_ratings_colors: {
            ru: 'Цвета',
            en: 'Colors',
            uk: 'Кольори',
            be: 'Колеры',
            pt: 'Cores',
            zh: '颜色',
            he: 'צבעים',
                        cs: 'Barvy',
            bg: 'Цветове'
        },
        maxsm_ratings_avg: {
            ru: 'ИТОГ',
            en: 'TOTAL',
            uk: 'ПІДСУМОК',
            be: 'ВЫНІК',
            pt: 'TOTAL',
            zh: '总评',
            he: 'סה"כ',
                        cs: 'VÝSLEDEK',
            bg: 'РЕЗУЛТАТ'
        },
        maxsm_ratings_avg_simple: {
            ru: 'Оценка',
            en: 'Rating',
            uk: 'Оцінка',
            be: 'Ацэнка',
            pt: 'Avaliação',
            zh: '评分',
            he: 'דירוג',
                        cs: 'Hodnocení',
            bg: 'Оценка'
        },
        maxsm_ratings_loading: {
            ru: 'Загрузка',
            en: 'Loading',
            uk: 'Завантаження',
            be: 'Загрузка',
            pt: 'Carregando',
            zh: '加载中',
            he: 'טוען',
                        cs: 'Načítání',
            bg: 'Зареждане'
        },
        maxsm_ratings_oscars: { 
            ru: 'Оскар',
            en: 'Oscar',
            uk: 'Оскар',
            be: 'Оскар',
            pt: 'Oscar',
            zh: '奥斯卡奖',
            he: 'אוסקר',
                        cs: 'Oscar',
            bg: 'Оскар'
        },
        maxsm_ratings_emmy: {
            ru: 'Эмми',
            en: 'Emmy',
            uk: 'Еммі',
            be: 'Эммі',
            pt: 'Emmy',
            zh: '艾美奖',
            he: 'אמי',
                        cs: 'Emmy',
            bg: 'Еми'
        },
        maxsm_ratings_awards: {
            ru: 'Награды',
            en: 'Awards',
            uk: 'Нагороди',
            be: 'Узнагароды',
            pt: 'Prêmios',
            zh: '奖项',
            he: 'פרסים',
                        cs: 'Ocenění',
            bg: 'Награди'
        },
        maxsm_ratings_pg: {
            ru: 'Возрастной рейтинг',
            en: 'Age rating',
            uk: 'Віковий рейтинг'
        },
        maxsm_ratings_status: {
            ru: 'Статус внутри карточек',
            en: 'Status inside cards',
            uk: 'Статус всередині карток'
        },
        maxsm_ratings_quality: {
            ru: 'Качество внутри карточек',
            en: 'Quality inside cards',
            uk: 'Якість всередині карток',
            be: 'Якасць унутры картак',
            pt: 'Qualidade dentro dos cartões',
            zh: '卡片内的质量',
            he: 'איכות בתוך כרטיסים',
                        cs: 'Kvalita uvnitř karet',
            bg: 'Качество вътре в картите'
        },
        maxsm_ratings_quality_inlist: {
            ru: 'Качество на карточках',
            en: 'Quality on cards',
            uk: 'Якість на картках',
            be: 'Якасць на картках',
            pt: 'Qualidade nos cartões',
            zh: '卡片上的质量',
            he: 'איכות בכרטיסים',
                        cs: 'Kvalita na kartách',
            bg: 'Качество по картите'
        },
        maxsm_ratings_quality_tv: {
            ru: 'Качество для сериалов',
            en: 'Quality for series',
            uk: 'Якість для серіалів',
            be: 'Якасць для серыялаў',
            pt: 'Qualidade para séries',
            zh: '剧集的质量',
            he: 'איכות לסדרות',
                        cs: 'Kvalita pro seriály',
            bg: 'Качество за сериали'
        }
    });

    // Стили
    var modalStyle = "<style id=\"maxsm_ratings_modal\">" +
        ".maxsm-quality {" +
        "background: #FFD700;" +
        "color: #000;" +
        "font-weight: bold;" +
	"}" +    
        ".maxsm-modal-ratings {" +
        "    padding: 1.25em;" +
        "    font-size: 1.4em;" +
        "    line-height: 1.6;" +
        "}" +
        ".maxsm-modal-rating-line {" +
        "    padding: 0.5em 0;" +
        "    border-bottom: 0.0625em solid rgba(255, 255, 255, 0.8);" +
        "}" +
        ".maxsm-modal-rating-line:last-child {" +
        "    border-bottom: none;" +
        "}" +
        ".maxsm-modal-imdb { color: #f5c518; }" +
        ".maxsm-modal-kp { color: #4CAF50; }" +
        ".maxsm-modal-tmdb { color: #01b4e4; }" +
        ".maxsm-modal-rt { color: #fa320a; }" +
        ".maxsm-modal-mc { color: #6dc849; }" +
        ".maxsm-modal-oscars, .maxsm-modal-emmy, .maxsm-modal-awards { color: #FFD700; }" +
        "</style>";
    
    Lampa.Template.add('maxsm_ratings_modal', modalStyle);
    $('body').append(Lampa.Template.get('maxsm_ratings_modal', {}, true));
    
    var style = "<style id=\"maxsm_ratings\">" +
        ".full-start-new__rate-line {" +
        "visibility: hidden;" +
        "left: 0.5em !important;" +
        //"flex-wrap: wrap !important;" +
        //"gap: 0.4em 0;" +  
        "}" +
        ".full-start-new__rate-line > * {" +
        "margin-right: 0.3em !important;" +
        "}" +
        ".full-start__rate {" +
        "background-color: rgba(0, 0, 0, 0.25) !important;" + // Добавлено: фон для каждого рейтинга
        "border-radius: 15px !important;" + // Добавлено: скругление углов
        "font-weight: bold !important;" +
        "padding: 0.1px 1px !important;" + // Добавлено: внутренние отступы
        "}" +
        ".full-start__rate > div:first-child {" +
        "border: none !important;" +
        "background: transparent !important;" +
        "padding: 0 !important;" +
        "}" +
        ".full-start-new__tagline.full--tagline {" +
        "position: relative !important;" +
        "bottom: 0.8em !important;" +
        "margin-bottom: 1.2em !important;" +
        "}" +
        ".full-start-new__title {" +
        "bottom: 0.3em !important;" +
        "font-size: 3.2em !important;" +
        "}" +
        ".card__view {position: relative !important;}" +
        ".card__quality { " +
        "   position: absolute !important; " +
        "   z-index: 10; " +
        "}" +		
        ".card__quality div {" +	
        "    font-weight: bold !important;" +	
        "}" +		
        ".rate--bylampa_full .source--name {" +
        "    width: 2em !important;" +  /* уменьшил с 2.6em */
        "    height: 2em !important;" + /* уменьшил с 2.4em */
        "    transform: scale(1.8) !important;" +
        "    box-sizing: border-box !important;" +
        "}" +
        ".rate--green  { color: #4caf50; }" +
        ".rate--lime   { color: #cddc39; }" +
        ".rate--orange { color: #ff9800; }" +
        ".rate--red    { color: #f44336; }" +
        ".rate--gold   { color: gold; }" +
        ".rate--icon    { height: 1.8em; }" +
        ".full-start__rate > div:last-child { padding: 0.2em 0.4em; }" +
        ".jr { min-width: 5.0em; }" +
        ".rutor { min-width: 7.0em; }" +
        ".maxsm-quality { min-width: 2.8em; text-align: center; }" +
        ".info__rate {" +
        "    background: rgba(0, 0, 0, 0.25) !important;" +
        "    border-radius: 1.4em !important;" +
        "    padding: 0.05em 0.7em !important;" +
        "    display: inline-flex !important;" +
        "    align-items: center !important;" +
        "    justify-content: center !important;" +
        "    gap: 0.1em !important;" +
        "    height: 2.9em !important;" +
        //"    min-width: 4em !important;" +
        "    margin-right: 1.8em !important;" +
        "    top: 0.02em !important;" +
        "    position: relative !important;" +
        "    box-sizing: border-box !important;" +
        "}" +
        ".info__rate div {" +
        "    background: transparent !important;" +
        "    border: none !important;" +
        "    box-shadow: none !important;" +
        "}" +
        ".info__rate span {" +
        "    font-size: 1.9em !important;" +
        "    margin-right: 2.5em !important;" +
        //"    top: -0.1em !important;" +
        "    font-weight: bold !important;" +
        "    line-height: 1 !important;" +
        "    text-align: center !important;" +
        "    flex-shrink: 0 !important;" +
        "    position: relative !important;" +
        "    vertical-align: baseline !important;" +
        "}" +
        ".info__rate .rate--icon {" +
        "    height: 5em !important;" +
        "    width: 4.8em !important;" +
        "    display: flex !important;" +
        "    align-items: center !important;" +
        "    justify-content: center !important;" +
        "    flex-shrink: 0 !important;" +
        "}" +
        ".info__rate .rate--icon svg {" +
        "    width: 100% !important;" +
        "    height: 100% !important;" +
        "    transform: translateY(0.45em) translateX(-0.2em) scaleY(1.3) !important;" +
        "}" +
        ".full-start-new__reactions {" +
        "    position: relative;" +
        "    margin-bottom: 3em !important;" +
        "}" +
        /* Стили для логотипов качества внутри карточки */
        ".full-start__status.maxsm-quality {" +
        "    min-width: auto !important;" +
        "    width: 2.5em !important;" +
        "    height: 1.5em !important;" +
        "    padding: 1px !important;" +
        "    border-radius: 0.2em !important;" +
        "    display: inline-flex !important;" +
        "    align-items: center !important;" +
        "    justify-content: center !important;" +
        //"    margin: 0 1px !important;" +
        "    background: rgba(0, 0, 0, 0.85) !important;" +
        "    border: 1px solid rgba(255, 255, 255, 1) !important;" +
        "    vertical-align: middle !important;" +
        "    overflow: hidden !important;" +
        "}" +    
        ".full-start__status.maxsm-quality img {" +
        "    height: 1.6em !important;" +
        "    width: 2.6em !important;" +
        //"    max-width: 1.8em !important;" +
        "    object-fit: contain !important;" +
        "}" +
        /* Стили для логотипов на карточках в списке */
        ".card__quality {" +
        "    position: absolute !important;" +
        "    bottom: 2.55em !important; " +
        "    left: -0.8em !important; " +
        "    width: 2.8em !important; " +  // Меньше для карточек
        "    max-width: calc(100% - 1em) !important; " +
        "    height: 1.7em !important;" +   // Меньше для карточек
        "    background: rgba(0, 0, 0, 0.8) !important; " +
        "    border-radius: 0.2em !important;" +
        "    border: 1px solid rgba(255, 255, 255, 0.15) !important;" +
        "    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3) !important;" +
        "    display: flex !important;" +
        "    align-items: center !important;" +
        "    justify-content: center !important;" +
        "    padding: 0.01em 0 !important;" +
        "    overflow: hidden !important;" +
        "    box-sizing: border-box !important;" +
        "}" +    
        ".card__quality img {" +
        "    height: 2em !important;" +   // Меньше для карточек
        "    width: auto !important;" +
        "    object-fit: contain !important;" +
        "    vertical-align: middle !important;" +
        "    display: block !important;" +
        "    margin: 0 auto !important;" +
        "}" +
        "</style>";
    
    Lampa.Template.add('maxsm_ratings_css', style);
    $('body').append(Lampa.Template.get('maxsm_ratings_css', {}, true));
        
    var loadingStyles = "<style id=\"maxsm_ratings_loading_animation\">" +
                    ".loading-dots-container {" +
                    "    position: absolute;" +
                    "    top: 50%;" +
                    "    left: 0;" +
                    "    right: 0;" +
                    "    text-align: left;" +
                    "    transform: translateY(-50%);" +
                    "    z-index: 10;" +
                    "}" +
                    ".full-start-new__rate-line {" +
                    "    position: relative;" +
                    "}" +
                    ".loading-dots {" +
                    "    display: inline-flex;" +
                    "    align-items: center;" +
                    "    gap: 0.4em;" +
                    "    color: #ffffff;" +
                    "    font-size: 1em;" +
                    "    background: rgba(0, 0, 0, 0.3);" +
                    "    padding: 0.6em 1em;" +
                    "    border-radius: 0.5em;" +
                    "}" +
                    ".loading-dots__text {" +
                    "    margin-right: 1em;" +
                    "}" +
                    ".loading-dots__dot {" +
                    "    width: 0.5em;" +
                    "    height: 0.5em;" +
                    "    border-radius: 50%;" +
                    "    background-color: currentColor;" +
                    "    opacity: 0.3;" +
                    "    animation: loading-dots-fade 1.5s infinite both;" + 
                    "}" +
                    ".loading-dots__dot:nth-child(1) {" +
                    "    animation-delay: 0s;" +
                    "}" +
                    ".loading-dots__dot:nth-child(2) {" +
                    "    animation-delay: 0.5s;" + 
                    "}" +
                    ".loading-dots__dot:nth-child(3) {" +
                    "    animation-delay: 1s;" +   
                    "}" +
                    "@keyframes loading-dots-fade {" +
                    "    0%, 90%, 100% { opacity: 0.3; }" + 
                    "    35% { opacity: 1; }" +             
                    "}" +
                    "@media screen and (max-width: 480px) { .loading-dots-container { -webkit-justify-content: center; justify-content: center; text-align: center; max-width: 100%; }}" +
                    "</style>";


    Lampa.Template.add('maxsm_ratings_loading_animation_css', loadingStyles);
    $('body').append(Lampa.Template.get('maxsm_ratings_loading_animation_css', {}, true));
    
    // Глобальная переменная текущей карточки (сейчас не используется)
    var globalCurrentCard = null;

    // Перепемнные настройки 
    var C_LOGGING = false;  // Общий логгинг 
    var Q_LOGGING = false;  // Логгинг качества
    var Q_CACHE_TIME = 24 * 60 * 60 * 1000;  // Время, которое кеш считается валидным
    var CACHE_TIME = 3 * 60 * 60 * 1000;
    var OMDB_CACHE = 'maxsm_ratings_omdb_cache';
    var KP_CACHE = 'maxsm_ratings_kp_cache';
    var ID_MAPPING_CACHE = 'maxsm_ratings_id_mapping_cache';
    var QUALITY_CACHE = 'maxsm_ratings_quality_cache';
    var OMDB_API_KEYS = (window.RATINGS_PLUGIN_TOKENS && window.RATINGS_PLUGIN_TOKENS.OMDB_API_KEYS) || ['18a1eec9', 'd3a7a896']; // api ключи массивом
    var KP_API_KEYS   = (window.RATINGS_PLUGIN_TOKENS && window.RATINGS_PLUGIN_TOKENS.KP_API_KEYS)   || ['ae8d6b29-b4ea-4f44-ad64-e99cb243289a', '5421e2f6-e0ed-4c08-aee9-492334f88937', '34abd082-4543-44a2-84fb-2169f49ce93e']; // api ключи массивом
    var PROXY_TIMEOUT = 5000; // Таймаут прокси
    var JACRED_PROTOCOL = 'http://'; // Протокол JacRed
    //var JACRED_URL = Lampa.Storage.get('jackett_url'); // Адрес JacRed для получения информации о карточках без протокола (jacred.xyz)
    //var JACRED_API_KEY = Lampa.Storage.get('jackett_key'); // api ключ JacRed
    var JACRED_URL = 'jacred.xyz';
    var JACRED_API_KEY = '';
    //var JACRED_URL = 'parser.ruzha.ru';
    //var JACRED_API_KEY = 'BCqr1JX01ISh';
    var PROXY_LIST = [  // Корс прокси для запросов	
        'http://cors.bwa.workers.dev/',
        'http://api.allorigins.win/raw?url='
    ];
    
    // Словарь возрастных рейтингов
    var AGE_RATINGS = {
        'G': '3+',
        'PG': '6+',
        'PG-13': '13+',
        'R': '17+',
        'NC-17': '18+',
        'TV-Y': '0+',
        'TV-Y7': '7+',
        'TV-G': '3+',
        'TV-PG': '6+',
        'TV-14': '14+',
        'TV-MA': '17+'
    };
    
    // Весовые коэффициенты для источников рейтингов
    var WEIGHTS = {
        imdb: 0.35,
        tmdb: 0.15,
        kp: 0.20,
        mc: 0.15,
        rt: 0.15
    };
    
    // Берем случайный токен из массива
    function getRandomToken(arr) {
      if (!arr || !arr.length) return '';
      return arr[Math.floor(Math.random() * arr.length)];
    }
    
    // Получаем количество наград
    function parseAwards(awardsText, localCurrentCard) {
        if (typeof awardsText !== 'string') return null;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Parse awards: " + awardsText);
    
        var result = {
            oscars: 0,
            awards: 0
        };
    
        var oscarMatch = awardsText.match(/Won (\d+) Oscars?/i);
        if (oscarMatch && oscarMatch[1]) {
            result.oscars = parseInt(oscarMatch[1], 10);
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Oscars: " + result.oscars);
        }

        var emmyMatch = awardsText.match(/Won (\d+) Primetime Emmys?/i);
        if (emmyMatch && emmyMatch[1]) {
            result.emmy = parseInt(emmyMatch[1], 10);
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Emmy: " + result.emmy);
        }
    
        var otherMatch = awardsText.match(/Another (\d+) wins?/i);
        if (otherMatch && otherMatch[1]) {
            result.awards = parseInt(otherMatch[1], 10);
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Awards (Another): " + result.awards);
        }
    
        if (result.awards === 0) {
            var simpleMatch = awardsText.match(/(\d+) wins?/i);
            if (simpleMatch && simpleMatch[1]) {
                result.awards = parseInt(simpleMatch[1], 10);
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Awards (Simple): " + result.awards);
            }
        }

        return result;
    }
    
    // Получение данных через прокси   
    function fetchWithProxy(url, localCurrentCard, callback) {
        var currentProxy = 0;
        var callbackCalled = false;
        function tryNextProxy() {
            if (currentProxy >= PROXY_LIST.length) {
                if (!callbackCalled) {
                    callbackCalled = true;
                    callback(new Error('All proxies failed'));
                }
                return;
            }
            var proxyUrl = PROXY_LIST[currentProxy] + encodeURIComponent(url);
            if (C_LOGGING)
                console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Fetch with proxy: " + proxyUrl);
            var timeoutId = setTimeout(function () {
                if (!callbackCalled) {
                    currentProxy++;
                    tryNextProxy();
                }
            }, PROXY_TIMEOUT);
            fetch(proxyUrl)
                .then(function (response) {
                clearTimeout(timeoutId);
                if (!response.ok)
                    throw new Error('Proxy error: ' + response.status);
                return response.text();
            })
                .then(function (data) {
                if (!callbackCalled) {
                    callbackCalled = true;
                    clearTimeout(timeoutId);
                    callback(null, data);
                }
            })
                .catch(function () {
                clearTimeout(timeoutId);
                if (!callbackCalled) {
                    currentProxy++;
                    tryNextProxy();
                }
            });
        }
        tryNextProxy();
    }
	
//-----------------------------------------------------get---kinopoisk-------------------------------------
    function getKPRatings(normalizedCard, apiKey, localCurrentCard, callback) {
        // Если есть kinopoisk_id - сразу переходим к запросу рейтингов
        if (normalizedCard.kinopoisk_id) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Using provided kinopoisk_id: " + normalizedCard.kinopoisk_id);
            return fetchRatings(normalizedCard.kinopoisk_id, localCurrentCard);
        }
    
        // Старая логика поиска по названию/году
        var queryTitle = (normalizedCard.original_title || normalizedCard.title || '').replace(/[:\-–—]/g, ' ').trim();
        var year = '';
        if (normalizedCard.release_date && typeof normalizedCard.release_date === 'string') {
            year = normalizedCard.release_date.split('-')[0];
        }
        
        if (!year) {
            callback(null);
            return;
        }
        
        var encodedTitle = encodeURIComponent(queryTitle);
        var searchUrl = 'https://kinopoiskapiunofficial.tech/api/v2.1/films/search-by-keyword?keyword=' + encodedTitle;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Find information in KP by title and year");        
        fetch(searchUrl, {
            method: 'GET',
            headers: {
                'X-API-KEY': apiKey,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            if (!response.ok) throw new Error('HTTP error: ' + response.status);
            return response.json();
        })
        .then(function(data) {
            if (!data.films || !data.films.length) {
                callback(null);
                return;
            }
            
            var bestMatch = null;
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Match KP inf");
            var filmYear;
            var targetYear;
            var film2;
            // Сначала пытаемся найти точное совпадение
            for (var j = 0; j < data.films.length; j++) {
                film2 = data.films[j];
                if (!film2.year) continue;
                
                filmYear = parseInt(film2.year.substring(0, 4), 10);
                targetYear = parseInt(year, 10);
                
                // Двойная проверка на валидность чисел
                if (isNaN(filmYear)) continue;
                if (isNaN(targetYear)) continue;
                
                if (filmYear === targetYear) {
                    bestMatch = film2;
                    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", KP EXACT match for: " + queryTitle + " / " + year + " is id: " + bestMatch.filmId + " / " + film2.nameRu + " / " + film2.nameEn + " / " + film2.year);
                    break;
                }
            }
            
            // Если точное совпадение не найдено, ищем +- год
            if (!bestMatch) {
                for (var k = 0; k < data.films.length; k++) {
                    film2 = data.films[k];
                    if (!film2.year) continue;
                    
                    filmYear = parseInt(film2.year.substring(0, 4), 10);
                    targetYear = parseInt(year, 10);
                    
                    // Двойная проверка на валидность чисел
                    if (isNaN(filmYear)) continue;
                    if (isNaN(targetYear)) continue;
                    
                    if (Math.abs(filmYear - targetYear) <= 1) {
                        bestMatch = film2;
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", KP APPROXIMATE match for: " + queryTitle + " / " + year + " is id: " + bestMatch.filmId + " / " + film2.nameRu + " / " + film2.nameEn + " / " + film2.year);
                        break;
                    }
                }
            }
            
            if (!bestMatch || !bestMatch.filmId) {
                callback(null);
                return;
            }
            
            fetchRatings(bestMatch.filmId, localCurrentCard);
        })
        .catch(function() {
            console.warn("MAXSM-RATINGS", "card: " + localCurrentCard + "Kinopoisk API request failed");
            callback(null);
        });
    
        // Общая функция получения рейтингов по ID
        function fetchRatings(filmId, localCurrentCard) {
            var xmlUrl = 'https://rating.kinopoisk.ru/' + filmId + '.xml';
            
            fetchWithProxy(xmlUrl, localCurrentCard, function(error, xmlText) {
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Try to get KP ratings from XML");
                if (!error && xmlText) {
                    try {
                        var parser = new DOMParser();
                        var xmlDoc = parser.parseFromString(xmlText, "text/xml");
                        var kpRatingNode = xmlDoc.getElementsByTagName("kp_rating")[0];
                        var imdbRatingNode = xmlDoc.getElementsByTagName("imdb_rating")[0];
                        
                        var kpRating = kpRatingNode ? parseFloat(kpRatingNode.textContent) : null;
                        var imdbRating = imdbRatingNode ? parseFloat(imdbRatingNode.textContent) : null;
                        
                        var hasValidKp = !isNaN(kpRating) && kpRating > 0;
                        var hasValidImdb = !isNaN(imdbRating) && imdbRating > 0;
                        
                        if (hasValidKp || hasValidImdb) {
                            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Got KP ratings from XML");
                            return callback({
                                kinopoisk: hasValidKp ? kpRating : null,
                                imdb: hasValidImdb ? imdbRating : null
                            });
                        }
                    } catch (e) {
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", XML parse error, fallback to API");
                    }
                }
                
                // Fallback к API
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Try to get KP ratings from API");
                fetch('https://kinopoiskapiunofficial.tech/api/v2.2/films/' + filmId, {
                    headers: { 'X-API-KEY': apiKey }
                })
                    .then(function(response) {
                        if (!response.ok) throw new Error('API error');
                        return response.json();
                    })
                    .then(function(data) {
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Got KP ratings from API");
                        callback({
                            kinopoisk: data.ratingKinopoisk || null,
                            imdb: data.ratingImdb || null
                        });
                    })
                    .catch(function() {
                        callback(null);
                    });
            });
        }
    }
//-------------------------------------------------end---get---kinopoisk-----------------------------------
    function addLoadingAnimation(localCurrentCard, render) {
        //var render = Lampa.Activity.active().activity.render();
        if (!render) return;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Add loading animation");
        var rateLine = $('.full-start-new__rate-line', render);
        if (!rateLine.length || $('.loading-dots-container', rateLine).length) return;

        rateLine.append(
            '<div class="loading-dots-container">' +
                '<div class="loading-dots">' +
                    '<span class="loading-dots__text">' + Lampa.Lang.translate("maxsm_ratings_loading") + '</span>' +
                    '<span class="loading-dots__dot"></span>' +
                    '<span class="loading-dots__dot"></span>' +
                    '<span class="loading-dots__dot"></span>' +
                '</div>' +
            '</div>'
        );

        $('.loading-dots-container', rateLine).css({
            'opacity': '1',
            'visibility': 'visible'
        });
    }

    // Улучшенная функция удаления анимации
    function removeLoadingAnimation(localCurrentCard, render) {
        if (!render) return;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Remove animation");
        // Ищем контейнеры с анимацией только внутри render
        var containers = $('.loading-dots-container', render);
        containers.each(function(index, element) {
            element.parentNode.removeChild(element);
        });
    }

    
    // Вспомогательные функции
    function getCardType(card) {
        var type = card.media_type || card.type;
        if (type === 'movie' || type === 'tv') return type;
        return card.name || card.original_name ? 'tv' : 'movie';
    }
    
    function getRatingClass(rating) {
        if (rating >= 8.5) return 'rate--green';
        if (rating >= 7.0) return 'rate--lime';
        if (rating >= 5.0) return 'rate--orange';
        return 'rate--red';
    }
    
// ------------------------------------------------------------JacRed------------------------------------------------------------------------------   
    function getBestReleaseFromJacred(normalizedCard, localCurrentCard, callback) {
        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Optimized search");
    
        var MAX_QUALITY = 2160;
        var stopWords = ['camrip', 'камрип', 'ts', 'telecine', 'telesync', 'telesynch', 'upscale', 'tc', 'тс'];
        var stopWordsPatterns = null;
    
        // Упрощенная функция перевода качества (работает с числами)
        function translateQuality(quality) {
            switch(quality) {
                case 2160: return '4K';
                case 1080: return 'FHD';
                case 720: return 'HD';
                case 'TS': return 'TS'; // Специальный случай
                default: 
                    // Для всех остальных числовых значений
                    return quality >= 720 ? 'HD' : 'SD';
            }
        }
    
        function hasLetters(str) {
            return /[a-zа-яё]/i.test(str || '');
        }
        function onlyDigits(str) {
            return /^\d+$/.test(str);
        }
        function isScreenCopy(title) {
            if (!title) return false;
            var lower = title.toLowerCase();
            
            if (stopWordsPatterns === null) {
                stopWordsPatterns = stopWords.map(function(word) {
                    return new RegExp('\\b' + word + '\\b', 'i');
                });
            }
    
            for (var i = 0; i < stopWordsPatterns.length; i++) {
                if (stopWordsPatterns[i].test(lower)) {
                    return true;
                }
            }
            return false;
        }
    
        // Извлечение года
        var year = '';
        var dateStr = normalizedCard.release_date || '';
        if (dateStr.length >= 4) {
            year = dateStr.substring(0, 4);
        }
    
        if (!year || isNaN(year)) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Missing/invalid year");
            callback(null);
            return;
        }
    
        var uid = Lampa.Storage.get('lampac_unic_id', '');
        var apiUrl = JACRED_PROTOCOL + JACRED_URL + '/api/v2.0/indexers/all/results?' +
                     'apikey=' + JACRED_API_KEY +
                     '&uid=' + uid +
                     '&year=' + year;
    
        // Добавляем оба заголовка если они есть
        var hasTitle = false;
        if (normalizedCard.title && (hasLetters(normalizedCard.title) || onlyDigits(normalizedCard.title))) {
            apiUrl += '&title=' + encodeURIComponent(normalizedCard.title.trim());
            hasTitle = true;
        }
        if (normalizedCard.original_title && (hasLetters(normalizedCard.original_title) || onlyDigits(normalizedCard.original_title))) {
            apiUrl += '&title_original=' + encodeURIComponent(normalizedCard.original_title.trim());
            hasTitle = true;
        }
    
        if (!hasTitle) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: No valid titles");
            callback(null);
            return;
        }
    
        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Unified Request URL: " + apiUrl);
    
        new Lampa.Reguest().silent(apiUrl, function(response) {
            if (!response) {
                if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Request failed");
                callback(null);
                return;
            }
    
            try {
                
                // ЛОГИРОВАНИЕ ПОЛНОГО ОТВЕТА
                /*
                if (Q_LOGGING) {
                    console.log("MAXSM-RATINGS JacRed FULL RESPONSE", response);
        
                }
                */
                
                // Парсим ответ и извлекаем Results
                var data = typeof response === 'string' ? JSON.parse(response) : response;
                var torrents = data.Results || [];
                
                if (!Array.isArray(torrents)) {
                    torrents = [];
                }
    
                if (torrents.length === 0) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Empty response");
                    callback(null);
                    return;
                }
    
                var bestQuality = -1;
                var bestTorrent = null;
                var findStopWords = false;
                var searchYearNum = parseInt(year, 10);
                var prevYear = searchYearNum - 1;
    
                for (var i = 0; i < torrents.length; i++) {
                    var t = torrents[i];
                    var info = t.info || t.Info || {};
                    var usedQuality = info.quality;
                    var usedYear = info.relased;
                    var titleForCheck = t.Title || '';
                    
                    // ЛОГИРОВАНИЕ ДЕТАЛЕЙ ТОРРЕНТА
                    /*
                    if (Q_LOGGING) {
                        console.log('MAXSM-RATINGS Processing torrent [${i+1}/${torrents.length}]: ${titleForCheck');
                        console.log("Raw data:", {
                            quality: usedQuality,
                            year: usedYear,
                            title: titleForCheck,
                            info: info
                        });
                    } 
                    */
    
                    // Пропускаем торренты без информации о качестве
                    if (typeof usedQuality !== 'number' || usedQuality === 0) {
                        continue;
                    }
    
                    // Проверяем валидность года
                    var yearValid = false;
                    var parsedYear = 0;
                    
                    if (usedYear && !isNaN(usedYear)) {
                        parsedYear = parseInt(usedYear, 10);
                        if (parsedYear > 1900) {
                            yearValid = true;
                        }
                    }
                    
                    if (!yearValid) {
                        continue;
                    }
    
                    // Проверяем соответствие года (текущий или предыдущий)
                    if (parsedYear !== searchYearNum && parsedYear !== prevYear) {
                        continue;
                    }
    
                    // Проверяем на стоп-слова
                    if (isScreenCopy(titleForCheck)) {
                        findStopWords = true;
                        continue;
                    }
    
                    // Проверяем максимальное качество
                    if (usedQuality === MAX_QUALITY) {
                        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Found MAX quality: " + usedQuality);
                        callback({ 
                            quality: translateQuality(usedQuality),
                            title: titleForCheck 
                        });
                        return;
                    }
    
                    // Обновляем лучший торрент
                    if (usedQuality > bestQuality) {
                        bestQuality = usedQuality;
                        bestTorrent = {
                            title: titleForCheck,
                            quality: usedQuality,
                            year: parsedYear
                        };
                    }
                }
    
                if (bestTorrent) {
                    var translatedQuality = translateQuality(bestTorrent.quality);
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + 
                        ", quality: JacRed: Found torrent: " + bestTorrent.title + 
                        " quality: " + translatedQuality + " (" + bestTorrent.quality + "p)" +
                        " year: " + bestTorrent.year);
                    callback({ 
                        quality: translatedQuality, 
                        title: bestTorrent.title 
                    });
                } else if (findStopWords) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Screen copy detected");
                    callback({ 
                        quality: translateQuality('TS'),
                        title: "NOT SAVED" 
                    });
                } else {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: No suitable torrents found");
                    callback(null);
                }
            } catch (e) {
                if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Processing error: " + e.message);
                callback(null);
            }
        });
    }
// v1
/*
    function getBestReleaseFromJacred(normalizedCard, localCurrentCard, callback) {
        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Optimized search");
    
        var MAX_QUALITY = 2160;
        var stopWords = ['camrip', 'камрип', 'ts', 'telecine', 'telesync', 'telesynch', 'upscale']; // Релизы с данными словами игнорируются
        var findStopWords = false;
        var stopWordsPatterns = null;
    
        function hasLetters(str) {
            return /[a-zа-яё]/i.test(str || '');
        }
        function onlyDigits(str) {
            return /^\d+$/.test(str);
        }
        function isScreenCopy(title) {
            if (!title) return false;
            var lower = title.toLowerCase();
            
            if (stopWordsPatterns === null) {
                stopWordsPatterns = stopWords.map(function(word) {
                    return new RegExp('\\b' + word + '\\b', 'i');
                });
            }
    
            for (var i = 0; i < stopWordsPatterns.length; i++) {
                if (stopWordsPatterns[i].test(lower)) {
                    return true;
                }
            }
            return false;
        }
    
        // Извлечение года
        var year = '';
        var dateStr = normalizedCard.release_date || '';
        if (dateStr.length >= 4) {
            year = dateStr.substring(0, 4);
        }
    
        if (!year || isNaN(year)) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Missing/invalid year");
            callback(null);
            return;
        }
    
        // Основная функция поиска
        function searchJacred(searchTitle, searchYear, exact, stepName, callback) {
            var uid = Lampa.Storage.get('lampac_unic_id', '');
            var apiUrl = JACRED_PROTOCOL + JACRED_URL + '/api/v1.0/torrents?search=' + 
                         encodeURIComponent(searchTitle) + 
                         '&year=' + searchYear + 
                         '&apikey=' + JACRED_API_KEY +
                         (exact ? '&exact=true' : '') +
                         '&uid=' + uid;
        
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: " + stepName + " URL: " + apiUrl);
        
            new Lampa.Reguest().silent(apiUrl, function(response) {
                if (!response) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: " + stepName + " failed");
                    callback(null);
                    return;
                }
        
                try {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: analizing answer...");
                    var torrents = typeof response === 'string' ? JSON.parse(response) : response;
                    if (!Array.isArray(torrents) || torrents.length === 0) {
                        callback(null);
                        return;
                    }
        
                    var bestQuality = -1;
                    var bestTorrent = null;
                    var findStopWords = false;
                    var searchYearNum = parseInt(searchYear, 10);
                        

        
                    for (var i = 0; i < torrents.length; i++) {
                        var t = torrents[i];
                        var usedQuality = t.quality;
                        var usedYear = t.relased;
                        var qualitySource = "original";
                        var yearSource = "original";
                        var yearStatus = "valid";
                        
                        // Обработка качества: если оригинальное качество 0 - пропускаем
                        if (typeof t.quality !== 'number' || t.quality === 0) {
                            // Временное отключение парсинга качества
                            continue; // Пропускаем релизы без качества
                        }
                        
                        // Обработка года: если оригинальный год невалиден - пропускаем
                        var yearValid = false;
                        var parsedYear = 0;
                        
                        if (usedYear && !isNaN(usedYear)) {
                            parsedYear = parseInt(usedYear, 10);
                            if (parsedYear > 1900) {
                                yearValid = true;
                            }
                        }
                        

                        
                        if (!yearValid) {
                            yearStatus = "invalid/missing";
                            continue; // Пропускаем релизы без года
                        }
                        
                        // Проверка соответствия года (если год известен)
                        if (yearValid) {
                            if (!isNaN(searchYearNum)) {
                                if (parsedYear === searchYearNum) {
                                    yearStatus = "match (" + parsedYear + " vs " + searchYearNum + ")";
                                } else {
                                    yearStatus = "mismatch (" + parsedYear + " vs " + searchYearNum + ")";
                                    continue; // Пропускаем торренты с несоответствующим годом
                                }
                            } else {
                                yearStatus = "no_search_year";
                            }
                        }
                        
                        // Проверка на screen copy
                        if (isScreenCopy(t.title)) {
                            findStopWords = true;
                            continue;
                        }
                        
                        
                        if (usedQuality === MAX_QUALITY) {
                            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Found MAX quality in " + stepName);
                            callback({
                                quality: usedQuality,
                                title: t.title
                            });
                            return;
                        }
                        
                        if (usedQuality > bestQuality) {
                            bestQuality = usedQuality;
                            bestTorrent = t;
                        }
                    }
        
                    if (bestTorrent) {
                        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Found in " + stepName + ": torrent: " + bestTorrent.title + " quality: " + bestQuality + "p");
                        callback({
                            quality: bestQuality,
                            title: bestTorrent.title
                        });
                    } else {
                        if (findStopWords) {
                            callback({
                                quality: "TS",
                                title: "NOT SAVED"
                            });                            
                        } else {
                            callback(null);
                        }
                    }
                } catch (e) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: " + stepName + " error: " + e.message);
                    callback(null);
                }
            });
        }
        
        // Последовательные стратегии поиска
        var searchStrategies = [];
        
        // Стратегия 1: По original_title (точное совпадение)
        if (normalizedCard.original_title && (hasLetters(normalizedCard.original_title) || onlyDigits(normalizedCard.original_title))) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Strategy added: OriginalTitle Exact Year");
            searchStrategies.push({
                title: normalizedCard.original_title.trim(),
                year: year,
                exact: true,
                name: "OriginalTitle Exact Year"
            });
        }
        
        // Стратегия 2: По original_title (точное совпадение) -1год
        if (normalizedCard.original_title && (hasLetters(normalizedCard.original_title) || onlyDigits(normalizedCard.original_title))) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Strategy added: OriginalTitle Exact Year-1");
            searchStrategies.push({
                title: normalizedCard.original_title.trim(),
                year: String(Number(year) - 1),
                exact: true,
                name: "OriginalTitle Exact Year-1"
            });
        }
        
        // Стратегия 3: По title (точное совпадение)
        if (normalizedCard.title && (hasLetters(normalizedCard.title) || onlyDigits(normalizedCard.title))) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Strategy added: Title Exact Year");
            searchStrategies.push({
                title: normalizedCard.title.trim(),
                year: year,
                exact: true,
                name: "Title Exact Year"
            });
        }
        
        // Стратегия 4: По title (точное совпадение) -1год
        if (normalizedCard.title && (hasLetters(normalizedCard.title) || onlyDigits(normalizedCard.title))) {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Strategy added: Title Exact Year-1");
            searchStrategies.push({
                title: normalizedCard.title.trim(),
                year: String(Number(year) - 1),
                exact: true,
                name: "Title Exact Year-1"
            });
        }
        
        // Рекурсивная проверка стратегий
        function tryNextStrategy(index) {
            if (index >= searchStrategies.length) {
                if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: All strategies failed");
                callback(null);
                return;
            }
            
            var strategy = searchStrategies[index];
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Trying " + strategy.name);
            
            searchJacred(strategy.title, strategy.year, strategy.exact, strategy.name, function(result) {
                if (result !== null) {
                    // ДОБАВЛЕН ЛОГ С НАЗВАНИЕМ РАЗДАЧИ
                    // if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: Selected torrent: \"" + result.title + "\"");
                    callback({ quality: result.quality + "p" });
                } else {
                    tryNextStrategy(index + 1);
                }
            });
        }
        
        // Запуск первой стратегии
        if (searchStrategies.length > 0) {
            tryNextStrategy(0);
        } else {
            if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: JacRed: No valid titles");
            callback(null);
        }
    }
    */
// ------------------------------------------------------------END--JacRed-------------------------------------------------------------------------     
    // Функции работы с качеством
    // Удаляем качество с карточки если есть
    function clearQualityElements(localCurrentCard, render) {
        if (render) $('.full-start__status.maxsm-quality', render).remove();
    }
    // Плейсхолдер качества
    function showQualityPlaceholder(localCurrentCard, render) {
        if (!render) return;
        
        var rateLine = $('.full-start-new__rate-line', render);
        if (!rateLine.length) return;
        
        // Проверяем, не добавлен ли уже плейсхолдер
        if (!$('.full-start__status.maxsm-quality', render).length) {
            var placeholder = document.createElement('div');
            placeholder.className = 'full-start__status maxsm-quality';
            placeholder.textContent = '...';
            placeholder.style.opacity = '0.7';
            rateLine.append(placeholder);
        } 
    }
    // Получаем касество
    function fetchQualitySequentially(normalizedCard, localCurrentCard, qCacheKey, render) {
        if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: Starting JacRed request');
        getBestReleaseFromJacred(normalizedCard, localCurrentCard, function(jrResult) {
            if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: JacRed callback received');
            var quality = (jrResult && jrResult.quality) || null;
            if (quality && quality !== 'NO') {
                if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: JacRed found quality: ' + quality);
                saveQualityCache(qCacheKey, { quality: quality }, localCurrentCard);
                updateQualityElement(quality, localCurrentCard, render);
                return;
            }
            clearQualityElements(localCurrentCard, render);
        });
    }
    // Обновляем качество в карточке
function updateQualityElement(quality, localCurrentCard, render) {
    if (!render) return;
    
    var element = $('.full-start__status.maxsm-quality', render);
    var rateLine = $('.full-start-new__rate-line', render);
    if (!rateLine.length) return;
    
    // Определяем URL иконки на основе качества
    var qualityIcon = '';
    switch(quality) {
        case '4K':
            qualityIcon = 'https://imjamoe1.github.io/quality/4K.png';
            break;
        case 'FHD':
            qualityIcon = 'https://imjamoe1.github.io/quality/FHD.png';
            break;
        case 'HD':
            qualityIcon = 'https://imjamoe1.github.io/quality/HD.png';
            break;
        case 'TS':
            qualityIcon = 'https://imjamoe1.github.io/quality/HD.png';
            break;
        default:
            // Для других значений качества (если есть)
            qualityIcon = '';
    }
    
    if (element.length) {
        if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: Updating existing element with quality "' + quality + '"');
        
        if (qualityIcon) {
            // Заменяем текст на иконку
            element.html('<img src="' + qualityIcon + '" alt="' + quality + '" style="height: 1.2em; vertical-align: middle;">');
        } else {
            element.text(quality);
        }
        element.css('opacity', '1');
    } else {
        if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: Creating new element with quality "' + quality + '"');
        
        var div = document.createElement('div');
        div.className = 'full-start__status maxsm-quality';
        
        if (qualityIcon) {
            div.innerHTML = '<img src="' + qualityIcon + '" alt="' + quality + '" style="height: 1.2em; vertical-align: middle;">';
        } else {
            div.textContent = quality;
        }
        
        rateLine.append(div);
    }
}

    // Основная функция
    function fetchAdditionalRatings(card, render) {
        if (!render) return;
        var localCurrentCard = card.id; 
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Start - card data: ", card);
        
        var normalizedCard = {
            id: card.id,
            tmdb: card.vote_average || null,
            kinopoisk_id: card.kinopoisk_id,
            imdb_id: card.imdb_id || card.imdb || null,
            title: card.title || card.name || '',
            original_title: card.original_title || card.original_name || '',
            type: getCardType(card),
            release_date: card.release_date || card.first_air_date || ''
        };
        
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", imdb id: " + normalizedCard.imdb_id + " title: " + normalizedCard.title + " orig: " + normalizedCard.original_title + " type: " + normalizedCard.type + " date: " + normalizedCard.release_date);
        
        var rateLine = $('.full-start-new__rate-line', render);
        if (rateLine.length) {
            rateLine.css('visibility', 'hidden');
            rateLine.addClass('done'); 
            addLoadingAnimation(localCurrentCard, render);
        }
        
        var cacheKey = normalizedCard.type + '_' + (normalizedCard.imdb_id || normalizedCard.id);
        var qCacheKey = normalizedCard.type + '_' + (normalizedCard.id || normalizedCard.imdb_id); 
        var cachedData = getOmdbCache(cacheKey);
        var cachedKpData = getKpCache(cacheKey);
        var cacheQualityData = getQualityCache(qCacheKey);
        var ratingsData = {};
        
        // Оптимищируем ли запросы 1 - экономия, 0 - точность (не избегаем запросов ксли на карточке есть IMDb и KP)
        // var optimize = parseInt(localStorage.getItem('maxsm_ratings_optimize'));

        // Статусы рейтингов
        var kpElement = $('.rate--kp:not(.hide)', render);
        var imdbElement = $('.rate--imdb:not(.hide)', render);
        
        // Проверяем, что оба рейтинга уже есть и содержат числовые значения
        var kpExists = kpElement.length > 0 && !!kpElement.find('> div').eq(0).text().trim();
        var imdbExists = imdbElement.length > 0 && !!imdbElement.find('> div').eq(0).text().trim();
            // Асинхронно ищем качество 
            if (localStorage.getItem('maxsm_ratings_quality') === 'true' && !(localStorage.getItem('maxsm_ratings_quality_tv') === 'false' && normalizedCard.type === 'tv')) {
                if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', quality: Start quality');
                // 1. Обрабатываем кеш качества
                if (cacheQualityData) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Get Quality data from cache");
                    updateQualityElement(cacheQualityData.quality, localCurrentCard, render);
                } else {
                    clearQualityElements(localCurrentCard, render);
                    showQualityPlaceholder(localCurrentCard, render);
                    fetchQualitySequentially(normalizedCard, localCurrentCard, qCacheKey, render);
                }
            } 
                
        // 1. Обрабатываем кеш Кинопоиска
        if (cachedKpData) {
            ratingsData.kp = cachedKpData.kp;
            ratingsData.imdb_kp = cachedKpData.imdb; 
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Get KP ratings from cache");
            processNextStep();
        } else {
            getKPRatings(normalizedCard, getRandomToken(KP_API_KEYS), localCurrentCard, function(kpRatings) {
                if (kpRatings) {
                    if (kpRatings.kinopoisk) {
                        ratingsData.kp = kpRatings.kinopoisk;
                    }
                    if (kpRatings.imdb) {
                        ratingsData.imdb_kp = kpRatings.imdb; // если хочешь сохранить отдельно, или сравнить
                    }
                    saveKpCache(cacheKey, { kp: kpRatings.kinopoisk, imdb: kpRatings.imdb }, localCurrentCard);
                }
                processNextStep();
            });
            return; // Выходим, продолжим в колбэке
        }
        
        function processNextStep() {

            updateHiddenElements(ratingsData, localCurrentCard, render);
            // 2. Обрабатываем кеш OMDB
            if (cachedData) {
                ratingsData.rt = cachedData.rt;
                ratingsData.mc = cachedData.mc;
                ratingsData.imdb = cachedData.imdb;
                ratingsData.ageRating = cachedData.ageRating;
                ratingsData.oscars = cachedData.oscars;
                ratingsData.emmy = cachedData.emmy;
                ratingsData.awards = cachedData.awards;
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Get OMDB ratings from cache");
                updateUI();
            } else if (normalizedCard.imdb_id) {
                fetchOmdbRatings(normalizedCard, cacheKey, localCurrentCard, render, function(omdbData) {
                    if (omdbData) {
                        ratingsData.rt = omdbData.rt;
                        ratingsData.mc = omdbData.mc;
                        ratingsData.imdb = omdbData.imdb;
                        ratingsData.ageRating = omdbData.ageRating;
                        ratingsData.oscars = omdbData.oscars;
                        ratingsData.emmy = omdbData.emmy;
                        ratingsData.awards = omdbData.awards;
                        saveOmdbCache(cacheKey, omdbData, localCurrentCard);
                    }
                    updateUI();
                });
            } else {
                getImdbIdFromTmdb(normalizedCard.id, normalizedCard.type, localCurrentCard, function(newImdbId) {
                    if (newImdbId) {
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", imdb id is: " + newImdbId);
                        normalizedCard.imdb_id = newImdbId;
                        cacheKey = normalizedCard.type + '_' + newImdbId;
                        fetchOmdbRatings(normalizedCard, cacheKey, localCurrentCard, render, function(omdbData) {
                            if (omdbData) {
                                ratingsData.rt = omdbData.rt;
                                ratingsData.mc = omdbData.mc;
                                ratingsData.imdb = omdbData.imdb;
                                ratingsData.ageRating = omdbData.ageRating;
                                ratingsData.oscars = omdbData.oscars;
                                ratingsData.emmy = omdbData.emmy;
                                ratingsData.awards = omdbData.awards;
                                saveOmdbCache(cacheKey, omdbData, localCurrentCard);
                            }
                            updateUI();
                        });
                    } else {
                        updateUI();
                    }
                });
            }
        }

        function updateUI() {
            // Вставляем рейтинги RT и MC
            insertRatings(ratingsData.rt, ratingsData.mc, ratingsData.oscars, ratingsData.awards, ratingsData.emmy, localCurrentCard, render);

            // Принудительно заменяем BYLAMPA на звездочку
            setTimeout(forceReplacebylampaWithStar, 100);
            setTimeout(replaceTmdbInFullStartDeta, 100);
            
            // Обновляем скрытые элементы
            updateHiddenElements(ratingsData, localCurrentCard, render);
            
            var mode = parseInt(localStorage.getItem('maxsm_ratings_mode'), 10);
            var isPortrait = window.innerHeight > window.innerWidth;
            if (isPortrait) mode = 1;
            
            // Считаем и отображаем средний рейтинг
            if (mode !== 2)
                calculateAverageRating(localCurrentCard, render);
            
            //Меняем лейблы на иконки если надо
            var showIcons = localStorage.getItem('maxsm_ratings_icons')  === 'true';
            if (showIcons) insertIcons(localCurrentCard, render);
            
            // Убираем анимацию и возвращаем строку рейтингов     
            removeLoadingAnimation(localCurrentCard, render);
            rateLine.css('visibility', 'visible');
            
            // Добавляем обработчик для портретного режима
            if (isPortrait) {
                var rateElement = $('.full-start__rate', render);
                rateElement.off('click.ratings-modal').on('click.ratings-modal', function(e) {
                    e.stopPropagation();
                    showRatingsModal(localCurrentCard, render);
                });
            }
            
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", RATE DONE");
       }
    }

function replaceTmdbInFullStartDeta() {
    var elements = document.querySelectorAll('.full-start__deta .info__rate .source--name');
    for (var i = 0; i < elements.length; i++) {
        var element = elements[i];
        var text = element.textContent || element.innerText || '';
        var trimmedText = text.trim().toUpperCase();
        
        if (trimmedText === 'TMDB' || trimmedText === 'TMDb') {
            element.innerHTML = tmdb_svg;
            element.classList.add('rate--icon');
            if (C_LOGGING) console.log("MAXSM-RATINGS", "Replaced TMDB in full-start__deta with logo");
        }
    }
}

// Функция для принудительной замены текста BYLAMPA на звездочку
function forceReplacebylampaWithStar() {
    // Несколько попыток с интервалами
    let attempts = 0;
    const maxAttempts = 5;
    
    function tryReplace() {
        attempts++;
        
        // Ищем всеми возможными способами
        const selectors = [
            '.rate--bylampa_full .source--name',
            '.rate--bylampa_full > div:last-child',
            '.rate--bylampa_full div.source--name',
            '[class*="bylampa"] .source--name',
            '.full-start__rate .source--name'
        ];
        
        let foundElements = false;
        
        selectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            
            elements.forEach(element => {
                const text = element.textContent || element.innerText || '';
                if (text.trim().toUpperCase() === 'BYLAMPA') {
                    element.innerHTML = bylampa_svg;
                    element.classList.add('source--name');
                    foundElements = true;
                    console.log("MAXSM-RATINGS: Replaced BYLAMPA with star using selector:", selector);
                }
            });
        });
        
        // Если не нашли или есть еще попытки, пробуем снова
        if (!foundElements && attempts < maxAttempts) {
            setTimeout(tryReplace, 200);
        } else if (foundElements) {
            console.log("MAXSM-RATINGS: Successfully replaced BYLAMPA with star");
        } else {
            console.log("MAXSM-RATINGS: Could not find BYLAMPA elements to replace");
        }
    }
    
    // Запускаем первую попытку
    setTimeout(tryReplace, 100);
}
    
//-------------------------------------------MODALKA---------------------------------------------------------
    function showRatingsModal(cardId, render) {
        // Проверяем настройку цветов
        var showColors = localStorage.getItem('maxsm_ratings_colors') === 'true';
        
        // Создаем контейнер для модального окна
        var modalContent = $('<div class="maxsm-modal-ratings"></div>');
        
        // Находим строку рейтингов
        var rateLine = $('.full-start-new__rate-line', render);
        if (!rateLine.length) return;
        
        // Порядок отображения рейтингов
        var ratingOrder = [
            'rate--avg',
            'rate--oscars',
            'rate--emmy',
            'rate--awards',
            'rate--tmdb',
            'rate--imdb',
            'rate--kp',
            'rate--rt',
            'rate--mc'
        ];
        
        // Собираем рейтинги в нужном порядке
        ratingOrder.forEach(function(className) {
            var element = $('.' + className, rateLine);
            if (element.length) {
                // Берем значение из первого дочернего элемента
                var value = element.children().eq(0).text().trim();
                var numericValue = parseFloat(value);
                
                // Определяем название рейтинга
                var label = '';
                switch(className) {
                    case 'rate--avg': 
                        label = Lampa.Lang.translate("maxsm_ratings_mode");
                        break;
                    case 'rate--oscars': 
                        label = Lampa.Lang.translate("maxsm_ratings_oscars");
                        break;
                    case 'rate--emmy': 
                        label = Lampa.Lang.translate("maxsm_ratings_emmy");
                        break;
                    case 'rate--awards': 
                        label = Lampa.Lang.translate("maxsm_ratings_awards");
                        break;
                    case 'rate--tmdb': 
                        label = 'TMDB';
                        break;
                    case 'rate--imdb': 
                        label = 'IMDb';
                        break;
                    case 'rate--kp': 
                        label = 'Кинопоиск';
                        break;
                    case 'rate--rt': 
                        label = 'Rotten Tomatoes';
                        break;
                    case 'rate--mc': 
                        label = 'Metacritic';
                        break;
                }
                
                // Создаем элемент строки с префиксными классами
                var item = $('<div class="maxsm-modal-rating-line"></div>');
                // Применяем цветовые классы если включена настройка
                if (showColors) {                
                var colorClass;
                    // Для среднего рейтинга используем специальную функцию
                    if (className === 'rate--avg') {
                        colorClass = getRatingClass(numericValue);
                        if (colorClass) {
                            item.addClass(colorClass);
                        }
                    }
                    // Для остальных рейтингов используем префиксные классы
                    else {
                        colorClass = 'maxsm-modal-' + className.replace('rate--', '');
                        item.addClass(colorClass);
                    }
                }
                item.text(value + ' - ' + label);
                modalContent.append(item);
            }
        });
        
        // Создаем модальное окно
        Lampa.Modal.open({
            title: Lampa.Lang.translate("maxsm_ratings_avg_simple"),
            html: modalContent,
            width: 600,
            onBack: function() {
                Lampa.Modal.close();
                Lampa.Controller.toggle('content');
                return true;
            }
        });
    }
//------------------------------------------------------------------------------------------------------------------------
    //Меняем лейблы на иконки
    function insertIcons(localCurrentCard, render) {
        if (!render) return;   
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert icons");       
        
        function replaceIcon(className, svg) {
            var Element = $('.' + className, render);
            //var Element = $('.' + className);
            if (Element.length) {
                var sourceNameElement = Element.find('.source--name');
                if (sourceNameElement.length) {
                    sourceNameElement.html(svg).addClass('rate--icon');
                    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert " + className);
                } else {
                    // Если не нашли .source--name, пробуем найти второй дочерний div
                    var childDivs = Element.children('div');
                    if (childDivs.length >= 2) {
                        $(childDivs[1]).html(svg).addClass('rate--icon');
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert " + className);
                    }
                }
            }
        }
        
        replaceIcon('rate--imdb', imdb_svg);
        replaceIcon('rate--kp', kp_svg);
        replaceIcon('rate--tmdb', tmdb_svg);
        replaceIcon('rate--lampa', lampa_svg);
        replaceIcon('rate--bylampa_full', bylampa_svg);
        replaceIcon('rate--oscars', oscars_svg);
        replaceIcon('rate--emmy', emmy_svg);
        replaceIcon('rate--awards', awards_svg);
        replaceIcon('rate--rt', rt_svg);
        replaceIcon('rate--mc', mc_svg);
        replaceIcon('rate--avg', avg_svg);
    }
    
    // Функции работы с кешем
    function getOmdbCache(key) {
        var cache = Lampa.Storage.get(OMDB_CACHE) || {};
        var item = cache[key];
        return item && (Date.now() - item.timestamp < CACHE_TIME) ? item : null;
    }

    function saveOmdbCache(key, data, localCurrentCard) {
        // Проверяем валидные рейтинги
        var hasValidRating = (
            (data.rt && data.rt !== "N/A") ||
            (data.mc && data.mc !== "N/A") ||
            (data.imdb && data.imdb !== "N/A")
        );
        
        // Проверяем валидный возрастной рейтинг
        var hasValidAgeRating = (
            data.ageRating && 
            data.ageRating !== "N/A" && 
            data.ageRating !== "Not Rated"
        );
        
        // Также считаем наличие Оскаров поводом кешировать
        var hasOscars = typeof data.oscars === 'number' && data.oscars > 0;
        var hasEmmy = typeof data.emmy === 'number' && data.emmy > 0;
        var hasAwards = typeof data.awards === 'number' && data.awards > 0;
        
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Save OMDB cache");
        
        var cache = Lampa.Storage.get(OMDB_CACHE) || {};
        cache[key] = { 
            rt: data.rt,
            mc: data.mc,
            imdb: data.imdb,
            ageRating: data.ageRating,
            oscars: data.oscars || null,
            emmy: data.emmy || null,
            awards: data.awards || null,
            timestamp: Date.now() 
        };
        Lampa.Storage.set(OMDB_CACHE, cache);
    }

    // Функции для работы с кешем Кинопоиска
    function getKpCache(key) {
        var cache = Lampa.Storage.get(KP_CACHE) || {};
        var item = cache[key];
        return item && (Date.now() - item.timestamp < CACHE_TIME) ? item : null;
    }
    
    function saveKpCache(key, data, localCurrentCard) {
        // Оптимищируем ли запросы 1 - экономия, 0 - точность (Сохраняем в кеш на N  дней и пустые результаты)
        //var optimize = parseInt(localStorage.getItem('maxsm_ratings_optimize'));
        
        // if (optimize === 0 && (!data || (!data.kp && !data.imdb))) return;
        
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Save KP cache");
    
        var cache = Lampa.Storage.get(KP_CACHE) || {};
    
        cache[key] = {
            kp: data.kp || null,
            imdb: data.imdb || null,
            timestamp: Date.now()
        };
    
        Lampa.Storage.set(KP_CACHE, cache);
    }
    
    // Функции для работы с кешем качества
    function getQualityCache(key) {
        var cache = Lampa.Storage.get(QUALITY_CACHE) || {};
        var item = cache[key];
        return item && (Date.now() - item.timestamp < Q_CACHE_TIME) ? item : null;
    }
    
    function saveQualityCache(key, data, localCurrentCard) {
        if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Save quality cache");
    
        var cache = Lampa.Storage.get(QUALITY_CACHE) || {};
    
        cache[key] = {
            quality: data.quality || null,
            timestamp: Date.now()
        };
    
        Lampa.Storage.set(QUALITY_CACHE, cache); 
    }
    
    // Получаем IMDB id из TMDB id по API
    function getImdbIdFromTmdb(tmdbId, type, localCurrentCard, callback) {
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Get IMDb id From TMDB");
        if (!tmdbId) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", TMDB id is empty - aborting");
            return callback(null);
        }
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Get IMDb id From TMDB for id:" + tmdbId);
        
        var cleanType = type === 'movie' ? 'movie' : 'tv';
        var cacheKey = cleanType + '_' + tmdbId;
        var cache = Lampa.Storage.get(ID_MAPPING_CACHE) || {};
        
        if (cache[cacheKey] && (Date.now() - cache[cacheKey].timestamp < CACHE_TIME)) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", find in cache imdb id is: " + cache[cacheKey].imdb_id);
            return callback(cache[cacheKey].imdb_id);
        }
        else if (cache[cacheKey]) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", cached entry expired for: " + cacheKey);
        }
    
        // Формируем основной URL с использованием Lampa.TMDB.api()
        var mainPath = cleanType + '/' + tmdbId + '/external_ids?api_key=' + Lampa.TMDB.key();
        var mainUrl = Lampa.TMDB.api(mainPath);
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", formed main API URL: " + mainUrl);
    
        // Используем только silent запрос
        new Lampa.Reguest().silent(mainUrl, function(data) {
            if (data && data.imdb_id) {
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", received IMDb id: " + data.imdb_id);
                cache[cacheKey] = {
                    imdb_id: data.imdb_id,
                    timestamp: Date.now()
                };
                Lampa.Storage.set(ID_MAPPING_CACHE, cache);
                callback(data.imdb_id);
            } else {
                if (C_LOGGING) {
                    console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", no IMDb id in main response");
                    if (data) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", main response data:", data);
                }
                
                if (cleanType === 'tv') {
                    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", trying alternative TV method");
                    
                    // Формируем альтернативный URL для TV
                    var altPath = 'tv/' + tmdbId + '?api_key=' + Lampa.TMDB.key();
                    var altUrl = Lampa.TMDB.api(altPath);
                    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", formed alternative API URL: " + altUrl);
                    
                    new Lampa.Reguest().silent(altUrl, function(altData) {
                        var imdbId = (altData && altData.external_ids && altData.external_ids.imdb_id) || null;
                        if (imdbId) {
                            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", alternative method found IMDb: " + imdbId);
                            cache[cacheKey] = {
                                imdb_id: imdbId,
                                timestamp: Date.now()
                            };
                            Lampa.Storage.set(ID_MAPPING_CACHE, cache);
                        } else {
                            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", alternative method NO IMDb id");
                        }
                        callback(imdbId);
                    }, function() {
                        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", alternative request failed");
                        callback(null);
                    });
                } else {
                    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", not TV type - skipping alternative");
                    callback(null);
                }
            }
        }, function(xhr) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", main request failed. Status: " + (xhr ? xhr.status : 'unknown'));
            callback(null);
        });
    }
    
    // Модифицируем fetchOmdbRatings для поддержки callback
    function fetchOmdbRatings(card, cacheKey, localCurrentCard, render, callback) {
        //var render = Lampa.Activity.active().activity.render();
        if (!render) return;   
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Fetch OMDB ratings");        
        // Статусы рейтингов
        var pgElement = $('.full-start__pg:not(.hide)', render);
        var imdbElement = $('.rate--imdb:not(.hide)', render);
        
        // Проверяем, что оба рейтинга уже есть и содержат числовые значения
        var pgExists = pgElement.length > 0 && !!pgElement.text().trim();
        var imdbExists = imdbElement.length > 0 && !!imdbElement.find('> div').eq(0).text().trim();
        
        if (!card.imdb_id) {
            callback(null);
            return;
        }
        
        var url = 'https://www.omdbapi.com/?apikey=' + getRandomToken(OMDB_API_KEYS) + '&i=' + card.imdb_id;
        
        new Lampa.Reguest().silent(url, function(data) {
            if (data && data.Response === 'True' && (data.Ratings || data.imdbRating)) {
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Got OMDB ratings from API");
                var parsedAwards = parseAwards(data.Awards || '', localCurrentCard);
                callback({
                    rt: extractRating(data.Ratings, 'Rotten Tomatoes'),
                    mc: extractRating(data.Ratings, 'Metacritic'),
                    imdb: data.imdbRating || null,
                    ageRating: data.Rated || null,
                    oscars: parsedAwards.oscars,
                    emmy: parsedAwards.emmy,
                    awards: parsedAwards.awards
                });
            } else {
                if (data && data.Response === 'False' && data.Error) {
                    if (C_LOGGING) console.warn("MAXSM-RATINGS", "card: " + localCurrentCard + ", OMDB error: " + data.Error);
                }
                callback(null);
            }
        }, function() {
            if (C_LOGGING) console.warn("MAXSM-RATINGS", "card: " + localCurrentCard + ", OMDB request failed");
            callback(null);
        });
    }
    
function updateHiddenElements(ratings, localCurrentCard, render) {
    if (!render) return;
    if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Update hidden elements");        
    
    // Обновление возрастного рейтинга
    var pgElement = $('.full-start__pg', render);
    if (pgElement.length && ratings.ageRating) {
        var invalidRatings = ['N/A', 'Not Rated', 'Unrated', 'NR'];
        var isValid = invalidRatings.indexOf(ratings.ageRating) === -1;
        
        var showPg = localStorage.getItem('maxsm_ratings_pg') === 'true';
        
        if (isValid && showPg) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert PG");
            var localizedRating = AGE_RATINGS[ratings.ageRating] || ratings.ageRating;
            pgElement.removeClass('hide').text(localizedRating);
        } else {
            // Скрываем, но НЕ удаляем
            pgElement.addClass('hide');
        }
    }

    var statusElement = $('.full-start__status', render);
    if (statusElement.length) {
        var showStatus = localStorage.getItem('maxsm_ratings_status') === 'true';
        
        if (showStatus) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Show status");
            statusElement.removeClass('hide');
        } else {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Hide status");
            statusElement.addClass('hide');
        }
    }
        
        // Заполняем IMDb рейтинга
        var imdbElement = $('.rate--imdb', render);
        if (imdbElement.length) {
            var imdbRating;
            if (ratings.imdb && !isNaN(ratings.imdb)) {
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert IMDB from OMDB");
                imdbRating = parseFloat(ratings.imdb).toFixed(1);
                imdbElement.removeClass('hide').find('> div').eq(0).text(imdbRating);
            }
            else if (ratings.imdb_kp && !isNaN(ratings.imdb_kp)) {
                if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert IMDB from KP");
                imdbRating = parseFloat(ratings.imdb_kp).toFixed(1);
                imdbElement.removeClass('hide').find('> div').eq(0).text(imdbRating);
            }
        }
        
        var kpElement = $('.rate--kp', render);
        if (kpElement.length && ratings.kp && !isNaN(ratings.kp)) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert KP");
            var kpRating = parseFloat(ratings.kp).toFixed(1);
            kpElement.removeClass('hide').find('> div').eq(0).text(kpRating);
        }
    }
    
    // Вспомогательные функции
    function extractRating(ratings, source) {
        if (!ratings || !Array.isArray(ratings)) return null;
        
        for (var i = 0; i < ratings.length; i++) {
            if (ratings[i].Source === source) {
                try {
                    return source === 'Rotten Tomatoes' 
                        ? parseFloat(ratings[i].Value.replace('%', '')) 
                        : parseFloat(ratings[i].Value.split('/')[0]);
                } catch(e) {
                    console.warn('Ошибка при парсинге рейтинга:', e);
                    return null;
                }
            }
        }
        return null;
    }
    
    function insertRatings(rtRating, mcRating, oscars, awards, emmy, localCurrentCard, render) {
        if (!render) return;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert OMDB ratings");  
        
        var rateLine = $('.full-start-new__rate-line', render);
        if (!rateLine.length) return;

        var lastRate = $('.full-start__rate:last', rateLine);
        
        var showRT = localStorage.getItem('maxsm_ratings_critic')  === 'true';
        var showMC = localStorage.getItem('maxsm_ratings_critic')  === 'true';
        var showAwards = localStorage.getItem('maxsm_ratings_awards') === 'true';
        var showOscar =  localStorage.getItem('maxsm_ratings_awards')  === 'true';
        var showColors = localStorage.getItem('maxsm_ratings_colors')  === 'true';    
        var showEmmy = localStorage.getItem('maxsm_ratings_awards')  === 'true';
        
        var elemLabel;
        
        if (showRT && rtRating && !isNaN(rtRating) && !$('.rate--rt', rateLine).length) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert Tomatoes");
            var rtElement = $(
                '<div class="full-start__rate rate--rt">' +
                    '<div>' + rtRating + '</div>' +
                    '<div class="source--name">Tomatoes</div>' +
                '</div>'
            );
            
            if (lastRate.length) {
                rtElement.insertAfter(lastRate);
            } else {
                rateLine.prepend(rtElement);
            }
        }
    
        if (showMC && mcRating && !isNaN(mcRating) && !$('.rate--mc', rateLine).length) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert Metacritic");
            var insertAfter = $('.rate--rt', rateLine).length ? $('.rate--rt', rateLine) : lastRate;
            var mcElement = $(
                '<div class="full-start__rate rate--mc">' +
                    '<div>' + mcRating + '</div>' +
                    '<div class="source--name">Metacritic</div>' +
                '</div>'
            );
            
            if (insertAfter.length) {
                mcElement.insertAfter(insertAfter);
            } else {
                rateLine.prepend(mcElement);
            }
        }

        if (showAwards && awards && !isNaN(awards) && awards > 0 && !$('.rate--awards', rateLine).length) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert Awards");
            var awardsElement = $(
                '<div class="full-start__rate rate--awards rate--gold">' +
                    '<div>' + awards + '</div>' +
                    '<div class="source--name">' + Lampa.Lang.translate("maxsm_ratings_awards") + '</div>' +
                '</div>'
            );
            if (!showColors) { 
                awardsElement.removeClass('rate--gold'); 
            }
            rateLine.prepend(awardsElement); // Просто вставляем в начало
        }
    
        if (showOscar && oscars && !isNaN(oscars) && oscars > 0 && !$('.rate--oscars', rateLine).length) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert Oscars");
            var oscarsElement = $(
                '<div class="full-start__rate rate--oscars rate--gold">' +
                    '<div>' + oscars + '</div>' +
                    '<div class="source--name">' + Lampa.Lang.translate("maxsm_ratings_oscars") + '</div>' +
                '</div>'
            );
            if (!showColors) { 
                oscarsElement.removeClass('rate--gold'); 
            }
            rateLine.prepend(oscarsElement); // Просто вставляем в начало
        }
        
        if (showEmmy && emmy && !isNaN(emmy) && emmy > 0 && !$('.rate--emmy', rateLine).length) {
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Insert Emmy");
            var emmyElement = $(
                '<div class="full-start__rate rate--emmy rate--gold">' +
                    '<div>' + emmy + '</div>' +
                    '<div class="source--name">' + Lampa.Lang.translate("maxsm_ratings_emmy") + '</div>' +
                '</div>'
            );
            if (!showColors) { 
                emmyElement.removeClass('rate--gold'); 
            }
            rateLine.prepend(emmyElement); // Просто вставляем в начало
        }
    }
    
    function calculateAverageRating(localCurrentCard, render) {
        if (!render) return;
        if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Calculate avarage rating");   
    
        var rateLine = $('.full-start-new__rate-line', render);
        if (!rateLine.length) return;
    
        var ratings = {
            tmdb: parseFloat($('.rate--tmdb div:first', rateLine).text()) || 0,
            imdb: parseFloat($('.rate--imdb div:first', rateLine).text()) || 0,
            kp: parseFloat($('.rate--kp div:first', rateLine).text()) || 0,
            mc: (parseFloat($('.rate--mc div:first', rateLine).text()) || 0) / 10,
            rt: (parseFloat($('.rate--rt div:first', rateLine).text()) || 0) / 10
        };
    
        var totalWeight = 0;
        var weightedSum = 0;
        var ratingsCount = 0;
        
        for (var key in ratings) {
            if (ratings.hasOwnProperty(key) && !isNaN(ratings[key]) && ratings[key] > 0) {
                weightedSum += ratings[key] * WEIGHTS[key];
                totalWeight += WEIGHTS[key];
                ratingsCount++;
            }
        }
    
        $('.rate--avg', rateLine).remove();
        
        var mode = parseInt(localStorage.getItem('maxsm_ratings_mode'), 10);
        var isPortrait = window.innerHeight > window.innerWidth;
        if (isPortrait) mode = 1;
        
        if (totalWeight > 0 && (ratingsCount > 1 ||  mode === 1)) {
            var averageRating = ( weightedSum / totalWeight ).toFixed(1);
            var colorClass = getRatingClass(averageRating);
            
            if (C_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", Average rating: " + averageRating);
            
            var avgLabel = Lampa.Lang.translate("maxsm_ratings_avg");
            
            if (mode === 1) {
                avgLabel = Lampa.Lang.translate("maxsm_ratings_avg_simple");
                $('.full-start__rate', rateLine).not('.rate--oscars, .rate--avg, .rate--awards').hide();
            } 

            var avgElement = $(
                '<div class="full-start__rate rate--avg ' + colorClass + '">' +
                    '<div>' + averageRating + '</div>' +
                    '<div class="source--name">' + avgLabel + '</div>' +
                '</div>'
            );

            var showColors = localStorage.getItem('maxsm_ratings_colors')  === 'true';
            
            if (!showColors) { 
                avgElement.removeClass(colorClass); 
            }
            
            $('.full-start__rate:first', rateLine).before(avgElement);
        }

    }
//------------------------------------------------- Лепим на карточки ярлыки качества (через получение с JacRed)
    function updateCards(cards) {
        for (var i = 0; i < cards.length; i++) {
            var card = cards[i];
            if (card.hasAttribute('data-quality-added')) continue;
            
            var cardView = card.querySelector('.card__view');
            if (localStorage.getItem('maxsm_ratings_quality_tv') === 'false') {
                if (cardView) {
                    var typeElements = cardView.getElementsByClassName('card__type');
                    if (typeElements.length > 0) continue;
                }
            }
    
            (function(currentCard) {
                var data = currentCard.card_data;
                if (!data) return;
                
                if (Q_LOGGING) console.log("MAXSM-RATINGS", "CARDLIST: card data: ", data);
                
                var normalizedCard = {
                    id: data.id || '',
                    title: data.title || data.name || '',
                    original_title: data.original_title || data.original_name || '',
                    release_date: data.release_date || data.first_air_date || '',
                    imdb_id: data.imdb_id || data.imdb || null,
                    type: getCardType(data)
                };     
                
                var localCurrentCard = normalizedCard.id;
                var qCacheKey = normalizedCard.type + '_' + (normalizedCard.id || normalizedCard.imdb_id); 
                var cacheQualityData = getQualityCache(qCacheKey); 
                
                // Если есть кеш - сразу применяем
                if (cacheQualityData) {
                    if (Q_LOGGING) console.log("MAXSM-RATINGS", "card: " + localCurrentCard + ", quality: Get Quality data from cache");
                    applyQualityToCard(currentCard, cacheQualityData.quality, 'Cache');
                } 
                // Если нет кеша - запрашиваем у JacRed
                else {
                    applyQualityToCard(currentCard, '...', 'Pending');
					getBestReleaseFromJacred(normalizedCard, localCurrentCard, function(jrResult) {
                        if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + localCurrentCard + ', CARDLIST: JacRed callback received');
                        var quality = (jrResult && jrResult.quality) || null;
                        applyQualityToCard(currentCard, quality, 'JacRed', qCacheKey);
                    });
                }
            })(card);
        }
    }

    // Общая функция для применения качества к карточке
function applyQualityToCard(card, quality, source, qCacheKey) {
    if (!document.body.contains(card)) {
        if (Q_LOGGING) console.log('MAXSM-RATINGS', 'Card removed from DOM:', card.card_data?.id);
        return;
    }
    
    card.setAttribute('data-quality-added', 'true');
    
    var cardView = card.querySelector('.card__view');
    var qualityElements = null;
    
    // Сохраняем в кеш если данные от JacRed
    if (source === 'JacRed' && quality && quality !== 'NO') {
        saveQualityCache(qCacheKey, { quality: quality }, card.card_data?.id);
    }
    
    // Определяем URL иконки на основе качества
    var qualityIcon = '';
    var displayText = quality;
    
    if (quality && quality !== '...') {
        switch(quality) {
            case '4K':
                qualityIcon = 'https://imjamoe1.github.io/quality/4K.png';
                break;
            case 'FHD':
                qualityIcon = 'https://imjamoe1.github.io/quality/FHD.png';
                break;
            case 'HD':
                qualityIcon = 'https://imjamoe1.github.io/quality/HD.png';
                break;
            case 'TS':
                qualityIcon = 'https://imjamoe1.github.io/quality/HD.png';
                break;
            default:
                // Для других значений качества оставляем текст
                displayText = quality;
        }
    }
    
    if (quality && quality !== 'NO' && quality !== '...') {
        if (Q_LOGGING) console.log('MAXSM-RATINGS', ' card: ' + (card.card_data?.id) + ', CARDLIST: ' + source + ' found quality: ' + quality);
        
        if (cardView) {
            var hasQuality = false;
            qualityElements = cardView.getElementsByClassName('card__quality');
            if (qualityElements.length > 0) hasQuality = true;
            
            var qualityDiv;
            var innerElement;
            
            if (!hasQuality) {
                qualityDiv = document.createElement('div');
                qualityDiv.className = 'card__quality';
                
                if (qualityIcon) {
                    // Создаем элемент с иконкой
                    var img = document.createElement('img');
                    img.src = qualityIcon;
                    img.alt = quality;
                    img.style.cssText = 'height: 1.2em; vertical-align: middle;';
                    qualityDiv.appendChild(img);
                } else {
                    // Или просто текст
                    qualityDiv.textContent = displayText;
                }
                
                cardView.appendChild(qualityDiv);
            } else {
                qualityDiv = qualityElements[0];
                innerElement = qualityDiv.firstElementChild;
                
                if (innerElement) {
                    if (qualityIcon) {
                        // Если это img элемент, обновляем src
                        if (innerElement.tagName === 'IMG') {
                            innerElement.src = qualityIcon;
                            innerElement.alt = quality;
                        } else {
                            // Если это текстовый элемент, заменяем на img
                            qualityDiv.innerHTML = '';
                            var img = document.createElement('img');
                            img.src = qualityIcon;
                            img.alt = quality;
                            img.style.cssText = 'height: 1.2em; vertical-align: middle;';
                            qualityDiv.appendChild(img);
                        }
                    } else {
                        // Если нет иконки, используем текст
                        innerElement.textContent = displayText;
                    }
                } else {
                    if (qualityIcon) {
                        var img = document.createElement('img');
                        img.src = qualityIcon;
                        img.alt = quality;
                        img.style.cssText = 'height: 1.2em; vertical-align: middle;';
                        qualityDiv.innerHTML = '';
                        qualityDiv.appendChild(img);
                    } else {
                        qualityDiv.textContent = displayText;
                    }
                }
            }
        }
    } else {
        // Удаляем качество если его нет
        if (cardView) {
            qualityElements = cardView.getElementsByClassName('card__quality');
            var elementsToRemove = [];
            for (var j = 0; j < qualityElements.length; j++) {
                elementsToRemove.push(qualityElements[j]);
            }
            for (var k = 0; k < elementsToRemove.length; k++) {
                var el = elementsToRemove[k];
                if (el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            }
        }
    }
}
    
    // Обсервер DOM для новых карт
    var observer = new MutationObserver(function(mutations) {
        var newCards = [];
        for (var m = 0; m < mutations.length; m++) {
            var mutation = mutations[m];
            if (mutation.addedNodes) {
                for (var j = 0; j < mutation.addedNodes.length; j++) {
                    var node = mutation.addedNodes[j];
                    if (node.nodeType !== 1) continue;
                    
                    if (node.classList && node.classList.contains('card')) {
                        newCards.push(node);
                    }
                    
                    var nestedCards = node.querySelectorAll('.card');
                    for (var k = 0; k < nestedCards.length; k++) {
                        newCards.push(nestedCards[k]);
                    }
                }
            }
        }
        
        if (newCards.length) updateCards(newCards);
    });
        
    // Инициализация плагина
    function startPlugin() {
        if (C_LOGGING) console.log("MAXSM-RATINGS", " Hello!"); 
        window.maxsmRatingsPlugin = true;
        
        if (!localStorage.getItem('maxsm_ratings_awards')) {
            localStorage.setItem('maxsm_ratings_awards', 'true');
        }
        if (!localStorage.getItem('maxsm_ratings_critic')) {
            localStorage.setItem('maxsm_ratings_critic', 'true');
        }
        if (!localStorage.getItem('maxsm_ratings_colors')) {
            localStorage.setItem('maxsm_ratings_colors', 'true');
        }
        
        if (!localStorage.getItem('maxsm_ratings_icons')) {
            localStorage.setItem('maxsm_ratings_icons', 'true');
        }
    
        if (!localStorage.getItem('maxsm_ratings_mode')) {
            localStorage.setItem('maxsm_ratings_mode', '0');
        }

        if (!localStorage.getItem('maxsm_ratings_pg')) {
            localStorage.setItem('maxsm_ratings_pg', 'true');
        }

        if (!localStorage.getItem('maxsm_ratings_status')) {
            localStorage.setItem('maxsm_ratings_status', 'true');
        }
        
        if (!localStorage.getItem('maxsm_ratings_quality')) {
            localStorage.setItem('maxsm_ratings_quality', 'true');
        }  

        if (!localStorage.getItem('maxsm_ratings_quality_inlist')) {
            localStorage.setItem('maxsm_ratings_quality_inlist', 'true');
        }  
        
        if (!localStorage.getItem('maxsm_ratings_quality_tv')) {
            localStorage.setItem('maxsm_ratings_quality_tv', 'false');
        }  
        
        Lampa.SettingsApi.addComponent({
            component: "maxsm_ratings",
            name: Lampa.Lang.translate("maxsm_ratings"),
            icon: star_svg
        });

        // Создание объекта для значений выбора режима
        var modeValue = {};
        modeValue[0] = Lampa.Lang.translate("maxsm_ratings_mode_normal");
        modeValue[1] = Lampa.Lang.translate("maxsm_ratings_mode_simple");
        modeValue[2] = Lampa.Lang.translate("maxsm_ratings_mode_noavg");
        
        var isPortrait = window.innerHeight > window.innerWidth;
        if (!isPortrait) {
            Lampa.SettingsApi.addParam({
                component: "maxsm_ratings",
                param: {
                    name: "maxsm_ratings_mode",
                    type: 'select',
                    values: modeValue,
                    default: 0
                },
                field: {
                    name: Lampa.Lang.translate("maxsm_ratings_mode"),
                    description: ''
                },
                onChange: function(value) {
    
                }
            });
        }

        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_awards",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_awards"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_critic",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_critic"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_colors",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_colors"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_icons",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_icons"),
                description: ''
            },
            onChange: function(value) {
            }
        });

        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_pg",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_pg"),
                description: ''
            },
            onChange: function(value) {
            }
        });

        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_status",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_status"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_quality",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_quality"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_quality_inlist",
                type: "trigger",
                default: true
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_quality_inlist"),
                description: ''
            },
            onChange: function(value) {
                console.log('MAXSM-RATINGS: observer value' + value);
                if (value === 'true') {
                    observer.observe(document.body, { childList: true, subtree: true });
                    console.log('MAXSM-RATINGS: observer Start');
                } else {
                    observer.disconnect();
                    console.log('MAXSM-RATINGS: observer Stop');
                }
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: "maxsm_ratings",
            param: {
                name: "maxsm_ratings_quality_tv",
                type: "trigger",
                default: false
            },
            field: {
                name: Lampa.Lang.translate("maxsm_ratings_quality_tv"),
                description: ''
            },
            onChange: function(value) {
            }
        });
        
        Lampa.SettingsApi.addParam({
            component: 'maxsm_ratings',
            param: {
                name: 'maxsm_ratings_cc',
                type: 'button'
            },
            field: {
                name: Lampa.Lang.translate('maxsm_ratings_cc')
            },
            onChange: function() {
                localStorage.removeItem(OMDB_CACHE);
                localStorage.removeItem(KP_CACHE);
                localStorage.removeItem(ID_MAPPING_CACHE);
                localStorage.removeItem(QUALITY_CACHE);
                window.location.reload();
            }
        });
        
        if (localStorage.getItem('maxsm_ratings_quality_inlist') === 'true') {
            // Вызов наблюдателя
            observer.observe(document.body, { childList: true, subtree: true });
            console.log('MAXSM-RATINGS: observer Start');
        }
        
        // Попадания внутри карточки
		Lampa.Listener.follow('full', function (e) {
			if (e.type == 'complite') {
				var render = e.object.activity.render();
				globalCurrentCard = e.data.movie.id;
                fetchAdditionalRatings(e.data.movie, render);
			}
		});
    }

// Добавление рейтинга Lampa на страницу полного описания
Lampa.Listener.follow('full', function(e) {
    if (e.type === 'complite') {
        const render = e.object.activity.render();
        const method = e.object.method;
        const id = e.object.id;
        
        // Проверяем, не находится ли мы в разделе
        if (window.location.href.indexOf('sisi') === -1) {
            fetchWithTimeout(`http://cub.rip/api/reactions/get/${method}_${id}`)
                .then(response => response.json())
                .then(data => {
                    const result = data.result;
                    let positive = 0, negative = 0;
                    
                    result.forEach(item => {
                        if (item.type === 'fire' || item.type === 'nice') {
                            positive += parseInt(item.counter, 10);
                        }
                        if (item.type === "think" || item.type === "bore" || item.type === 'shit') {
                            negative += parseInt(item.counter, 10);
                        }
                    });
                    
                    const total = positive + negative;
                    const rating = total > 0 ? (positive / total * 10).toFixed(1) : 0;
                    
                    const ratingElement = $(`<div class="full-start__rate rate--lampa"></div>`);
                    const ratingValue = $(`<div></div>`).text(rating);
                    const sourceIcon = $(`<div class="source--name rate--icon" style="transform: scale(1.1);">${lampa_svg}</div>`);
                    
                    ratingElement.append(ratingValue);
                    ratingElement.append(sourceIcon);
                    
                    $(".rate--kp", render).after(ratingElement);
                })
                .catch(() => {});
        }
    }
});

    function fetchWithTimeout(url, options = {}, timeout = 5000) {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Request timeout')), timeout)
        )
    ]);
}

Lampa.Listener.follow('full', function(e) {
    if (e.type == 'complite') {
        setTimeout(function() {
            try {
                var render = e.object.activity.render();
                var rateLine = $('.full-start-new__rate-line', render);
                var head = $('.full-start-new__head', render);
                
                if (rateLine.length && head.length) {
                    // Находим общий родительский контейнер
                    var parentContainer = head.parent();
                    
                    if (parentContainer.length) {
                        // 1. Перемещаем rateLine перед head внутри их общего родителя
                        rateLine.insertBefore(head);
                        
                        // 2. Применяем стили
                        rateLine.css({
                            'visibility': 'visible',
                            'margin-left': '-10px',
                            'margin-bottom': '10px',
                            'display': 'flex',
                            'flex-wrap': 'wrap'
                        });
                        
                        // 3. Добавляем отступ для head, чтобы не наезжал
                        head.css('margin-top', '5px');
                        
                        console.log('MAXSM-RATINGS: Rate line positioned above head');
                    }
                }
            } catch(err) {
                console.error('MAXSM-RATINGS: Error:', err);
            }
        }, 100);
    }
});

Lampa.Listener.follow('full', function(e) {
    if (e.type == 'complite') {
        setTimeout(function() {
            var render = e.object.activity.render();
            var head = render.find('.full-start-new__head');
            var details = render.find('.full-start-new__details');
            
            if (!head.length || !details.length) return;
            
            // Сохраняем оригинальный контент details
            var originalDetailsHTML = details.html();
            
            // SVG иконки - для длительности и следующей серии
            var timeSVG = '<svg width="1em" height="1em" viewBox="0 0 512 512"><path fill="#fff" d="M256,0C114.845,0,0,114.839,0,256s114.845,256,256,256c141.161,0,256-114.839,256-256S397.155,0,256,0z M256,474.628C135.45,474.628,37.372,376.55,37.372,256S135.45,37.372,256,37.372s218.628,98.077,218.628,218.622C474.628,376.55,376.55,474.628,256,474.628z M343.202,256h-80.973V143.883c0-10.321-8.365-18.686-18.686-18.686s-18.686,8.365-18.686,18.686v130.803c0,10.321,8.365,18.686,18.686,18.686h99.659c10.321,0,18.686-8.365,18.686-18.686S353.523,256,343.202,256z"/></svg>';
            
            // Получаем текст
            var headText = head.text();
            var detailsText = details.text();
            
            // Проверяем, это сериал или фильм
            var isSeries = false;
            var seriesInfo = [];
            var durationElement = null;
            var nextEpisodeInfo = null;
            
            // Ищем всю информацию о сериалах
            var tempDiv = $('<div>').html(originalDetailsHTML);
            var seriesElements = tempDiv.find('span, div');
            
            // Собираем все части информации о сериале
            seriesElements.each(function() {
                var text = $(this).text().trim();
                if (text.includes('Сезон') || text.includes('сезон') || 
                    text.includes('Серии') || text.includes('серии') ||
                    text.includes('Следующ') || text.includes('следующ')) {
                    isSeries = true;
                    // Разбиваем на отдельные части если есть разделители
                    var parts = text.split(/[●·]/).map(p => p.trim()).filter(p => p);
                    seriesInfo = seriesInfo.concat(parts);
                }
            });
            
            // Если не нашли в спанах, ищем в тексте details
            if (seriesInfo.length === 0) {
                var lines = detailsText.split('●');
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (line.includes('Сезон') || line.includes('сезон') || 
                        line.includes('Серии') || line.includes('серии') ||
                        line.includes('Следующ') || line.includes('следующ')) {
                        isSeries = true;
                        var parts = line.split(/[●·]/).map(p => p.trim()).filter(p => p);
                        seriesInfo = seriesInfo.concat(parts);
                    }
                }
            }
            
            // Извлекаем данные из head
            var year = headText.match(/(\d{4})/);
            var country = headText.match(/,\s*([^,]+)/);
            
            var tags = [];
            
            // Год (БЕЗ иконки)
            if (year) tags.push({icon: '', text: year[1]});
            
            // Страна (БЕЗ иконки)
            if (country) tags.push({icon: '', text: country[1].trim()});
            
            // Разбиваем details на части
            var parts = detailsText.split('●').map(p => p.trim()).filter(p => p);
            
            // Добавляем жанры (исключая информацию о сериалах)
            parts.forEach(function(part) {
                if (part.includes('|')) {
                    // Проверяем, что это не информация о сериале
                    var isSeriesPart = false;
                    for (var i = 0; i < seriesInfo.length; i++) {
                        if (part.includes(seriesInfo[i])) {
                            isSeriesPart = true;
                            break;
                        }
                    }
        
                    if (!isSeriesPart) {
                        var formattedGenres = part.replace(/\s*\|\s*/g, ' , ');
                        tags.push({icon: '', text: formattedGenres});
                    }
                }
    
                // Находим время (длительность) - отдельно от информации о сериалах
                if (part.match(/\d{2}:\d{2}/)) {
                    // Проверяем, что это не "Следующая HH:MM" и не часть информации о сезонах
                    var isSeriesTime = false;
                    for (var i = 0; i < seriesInfo.length; i++) {
                        if (part.includes(seriesInfo[i]) || seriesInfo[i].includes(part)) {
                            isSeriesTime = true;
                            break;
                        }
                    }
        
                    if (!isSeriesTime && !part.includes('Следующ') && !part.includes('следующ')) {
                        durationElement = {icon: timeSVG, text: part};
                    }
        
                    // Отдельно сохраняем информацию о следующей серии
                    if (part.includes('Следующ') || part.includes('следующ')) {
                        nextEpisodeInfo = {icon: timeSVG, text: part};
                    }
                }
            });
            
            // Добавляем длительность в конец (если есть) С ИКОНКОЙ
            if (durationElement) {
                tags.push(durationElement);
            }
            
            // Создаем HTML для первой строки
            var tagsHtml = '';
            
            if (tags.length > 0) {
                tagsHtml = tags.map(function(tag) {
                    var content = tag.icon ? tag.icon + ' ' + tag.text : tag.text;
                    return '<span class="maxsm-tag-item">' + content + '</span>';
                }).join('');
            }
            
            // Для сериалов добавляем отдельные теги для сезонов, серий и следующей серии
            if (isSeries && seriesInfo.length > 0) {
                // Фильтруем уникальные значения
                var uniqueSeriesInfo = [];
                seriesInfo.forEach(function(item) {
                    if (uniqueSeriesInfo.indexOf(item) === -1 && item) {
                        uniqueSeriesInfo.push(item);
                    }
                });
                
                // Создаем отдельные теги для каждой части информации
                var seriesTagsHtml = '';
                uniqueSeriesInfo.forEach(function(item) {
                    // Проверяем, что это не длительность (формат HH:MM)
                    if (!item.match(/^\d{2}:\d{2}$/)) {
                        // Для "Следующая HH:MM" добавляем иконку часов
                        if (item.includes('Следующ') || item.includes('следующ')) {
                            seriesTagsHtml += '<span class="maxsm-tag-item">' + timeSVG + ' ' + item + '</span>';
                        } else {
                            // Для сезонов и серий без иконки
                            seriesTagsHtml += '<span class="maxsm-tag-item">' + item + '</span>';
                        }
                    }
                });
                
                // Если у нас есть отдельная информация о следующей серии, добавляем её
                if (nextEpisodeInfo && !seriesTagsHtml.includes('Следующ') && !seriesTagsHtml.includes('следующ')) {
                    seriesTagsHtml += '<span class="maxsm-tag-item">' + timeSVG + ' ' + nextEpisodeInfo.text + '</span>';
                }
                
                if (seriesTagsHtml) {
                    tagsHtml += '<div class="maxsm-series-container">' + seriesTagsHtml + '</div>';
                }
            }
            
            if (tagsHtml) {
                details.html('<div class="maxsm-tags-container">' + tagsHtml + '</div>');
                
                // Стили
                var style = '<style id="maxsm-tags-equal">' +
                    '.maxsm-tags-container {' +
                    '    display: flex !important;' +
                    '    align-items: center !important;' +
                    '    flex-wrap: wrap !important;' +
                    '    gap: 0.5em !important;' +
                    '    margin: 0.75em 0 1em 0 !important;' +
                    '}' +
                    '.maxsm-tag-item {' +
                    '    display: inline-flex !important;' +
                    '    align-items: center !important;' +
                    '    gap: 0.3em !important;' +
                    '    padding: 0.25em 0.75em !important;' +
                    '    background: rgba(0, 0, 0, 0.2) !important;' +
                    '    border-radius: 0.6em !important;' +
                    '    font-size: 1.1em !important;' +
                    '    color: rgba(255, 255, 255, 0.95) !important;' +
                    '    line-height: 1 !important;' +
                    '    min-height: 1.5em !important;' +
                    '    box-sizing: border-box !important;' +
                    '}' +
                    '.maxsm-tag-item svg {' +
                    '    flex-shrink: 0 !important;' +
                    '    width: 1em !important;' +
                    '    height: 1em !important;' +
                    '}' +
                    '.maxsm-series-container {' +
                    '    width: 100% !important;' +
                    '    display: flex !important;' +
                    '    flex-wrap: wrap !important;' +
                    '    gap: 0.5em !important;' +
                    '    margin-top: 0.5em !important;' +
                    '}' +
                    '</style>';
                
                if (!$('#maxsm-tags-equal').length) {
                    $('head').append(style);
                }
                
                // Очищаем head
                var rateLine = head.find('.full-start-new__rate-line');
                if (rateLine.length) {
                    head.html(rateLine);
                    rateLine.css('visibility', 'visible');
                } else {
                    head.remove();
                }
            }
            
        }, 300);
    }
});

Lampa.Listener.follow('full', function(e) {
    if (e.type == 'complite') {
        setTimeout(function() {
            try {
                var render = e.object.activity.render();
                var originalTitleElement = $('.original-title', render);
                var titleElement = $('.full-start-new__title', render);
                
                if (originalTitleElement.length && titleElement.length) {
                    // Находим общий родительский контейнер
                    var parentContainer = titleElement.parent();
                    
                    if (parentContainer.length) {
                        // 1. Перемещаем originalTitleElement перед titleElement
                        titleElement.before(originalTitleElement);
                        
                        // 2. Применяем стили
                        originalTitleElement.css({
                            'font-size': '1.5em',
                            'margin-top': '0.3em',
                            'margin-bottom': '0.3em'
                        });
                        
                        // 3. Добавляем отступ для titleElement, чтобы не наезжал
                        titleElement.css('margin-top', '5px');
                        
                        console.log('MAXSM-RATINGS: Original title positioned above titleElement');
                    }
                }
            } catch(err) {
                console.error('MAXSM-RATINGS: Error:', err);
            }
        }, 100);
    }
});

    /**
     * Анализирует качество контента из данных ffprobe
     * Извлекает информацию о разрешении, HDR, Dolby Vision, аудио каналах
     */
    function analyzeContentQuality(ffprobe) {
        if (!ffprobe || !Array.isArray(ffprobe)) return null;

        const quality = {
            resolution: null,
            hdr: false,
            dolbyVision: false,
            audio: null
        };

        // Анализ видео потока
        const video = ffprobe.find(stream => stream.codec_type === 'video');
        if (video) {
            // Разрешение
            if (video.width && video.height) {
                quality.resolution = `${video.width}x${video.height}`;
                
                // Определяем метки качества
                // Проверяем и ширину для широкоформатного контента (2.35:1, 2.39:1 и т.д.)
                if (video.height >= 2160 || video.width >= 3840) {
                    quality.resolutionLabel = '4K';
                } else if (video.height >= 1440 || video.width >= 2560) {
                    quality.resolutionLabel = '2K';
                } else if (video.height >= 1080 || video.width >= 1920) {
                    quality.resolutionLabel = 'FULL HD';
                } else if (video.height >= 720 || video.width >= 1280) {
                    quality.resolutionLabel = 'HD';
                }
            }

            // HDR определяется через side_data_list или color_transfer
            if (video.side_data_list) {
                const hasMasteringDisplay = video.side_data_list.some(data => 
                    data.side_data_type === 'Mastering display metadata'
                );
                const hasContentLight = video.side_data_list.some(data => 
                    data.side_data_type === 'Content light level metadata'
                );
                const hasDolbyVision = video.side_data_list.some(data => 
                    data.side_data_type === 'DOVI configuration record' ||
                    data.side_data_type === 'Dolby Vision RPU'
                );

                if (hasDolbyVision) {
                    quality.dolbyVision = true;
                    quality.hdr = true; // DV всегда включает HDR
                } else if (hasMasteringDisplay || hasContentLight) {
                    quality.hdr = true;
                }
            }

            // Альтернативная проверка HDR через color_transfer
            if (!quality.hdr && video.color_transfer) {
                const hdrTransfers = ['smpte2084', 'arib-std-b67'];
                if (hdrTransfers.includes(video.color_transfer.toLowerCase())) {
                    quality.hdr = true;
                }
            }

            // Проверка через codec_name для Dolby Vision
            if (!quality.dolbyVision && video.codec_name) {
                if (video.codec_name.toLowerCase().includes('dovi') || 
                    video.codec_name.toLowerCase().includes('dolby')) {
                    quality.dolbyVision = true;
                    quality.hdr = true;
                }
            }
        }

        // Анализ аудио потоков
        const audioStreams = ffprobe.filter(stream => stream.codec_type === 'audio');
        let maxChannels = 0;
        
        audioStreams.forEach(audio => {
            if (audio.channels && audio.channels > maxChannels) {
                maxChannels = audio.channels;
            }
        });

        // Определяем аудио формат
        if (maxChannels >= 8) {
            quality.audio = '7.1';
        } else if (maxChannels >= 6) {
            quality.audio = '5.1';
        } else if (maxChannels >= 4) {
            quality.audio = '4.0';
        } else if (maxChannels >= 2) {
            quality.audio = '2.0';
        }

        return quality;
    }

    /**
     * Анализирует качество контента при переходе на страницу full
     */
    function analyzeContentQualities(movie, activity) {
        if (!movie || !Lampa.Storage.field('parser_use')) return;

        // Получаем данные от парсера самостоятельно
        if (!Lampa.Parser || typeof Lampa.Parser.get !== 'function') {
            return;
        }

        const title = movie.title || movie.name || 'Неизвестно';
        
        // Формируем параметры для парсера
        const year = ((movie.first_air_date || movie.release_date || '0000') + '').slice(0,4);
        const combinations = {
            'df': movie.original_title,
            'df_year': movie.original_title + ' ' + year,
            'df_lg': movie.original_title + ' ' + movie.title,
            'df_lg_year': movie.original_title + ' ' + movie.title + ' ' + year,
            'lg': movie.title,
            'lg_year': movie.title + ' ' + year,
            'lg_df': movie.title + ' ' + movie.original_title,
            'lg_df_year': movie.title + ' ' + movie.original_title + ' ' + year,
        };

        const searchQuery = combinations[Lampa.Storage.field('parse_lang')] || movie.title;

        // Вызываем парсер
        Lampa.Parser.get({
            search: searchQuery,
            movie: movie,
            page: 1
        }, (results) => {
            if (!activity || activity.__destroyed) return;

            // Получили результаты парсера
            if (!results || !results.Results || results.Results.length === 0) return;

            // Собираем итоговую информацию о доступных качествах
            const availableQualities = {
                resolutions: new Set(),
                hdr: new Set(),
                audio: new Set(),
                hasDub: false
            };

            // Анализируем каждый торрент
            results.Results.forEach((torrent) => {
                // Анализируем ffprobe если есть
                if (torrent.ffprobe && Array.isArray(torrent.ffprobe)) {
                    const quality = analyzeContentQuality(torrent.ffprobe);
                    
                    if (quality) {
                        // Разрешение
                        if (quality.resolutionLabel) {
                            availableQualities.resolutions.add(quality.resolutionLabel);
                        }
                        
                        // Аудио
                        if (quality.audio) {
                            availableQualities.audio.add(quality.audio);
                        }
                    }

                    // Проверяем наличие русского дубляжа
                    if (!availableQualities.hasDub) {
                        const audioStreams = torrent.ffprobe.filter(stream => stream.codec_type === 'audio' && stream.tags);
                        audioStreams.forEach(audio => {
                            const lang = (audio.tags.language || '').toLowerCase();
                            const title = (audio.tags.title || audio.tags.handler_name || '').toLowerCase();
                            
                            // Проверяем русский язык
                            if (lang === 'rus' || lang === 'ru' || lang === 'russian') {
                                // Проверяем что это дубляж
                                if (title.includes('dub') || title.includes('дубляж') || 
                                    title.includes('дублир') || title === 'd') {
                                    availableQualities.hasDub = true;
                                }
                            }
                        });
                    }
                }

                // Анализируем название торрента для HDR/DV
                const titleLower = torrent.Title.toLowerCase();
                
                if (titleLower.includes('dolby vision') || titleLower.includes('dovi') || titleLower.match(/\bdv\b/)) {
                    availableQualities.hdr.add('Dolby Vision');
                }
                if (titleLower.includes('hdr10+')) {
                    availableQualities.hdr.add('HDR10+');
                }
                if (titleLower.includes('hdr10')) {
                    availableQualities.hdr.add('HDR10');
                }
                if (titleLower.includes('hdr')) {
                    availableQualities.hdr.add('HDR');
                }
            });

            // Формируем структурированный объект с качеством
            const qualityInfo = {
                title: title,
                torrents_found: results.Results.length,
                quality: null,
                dv: false,
                hdr: false,
                hdr_type: null,
                sound: null,
                dub: availableQualities.hasDub
            };

            // Разрешение - берем только максимальное
            if (availableQualities.resolutions.size > 0) {
                const resOrder = ['8K', '4K', '2K', 'FULL HD', 'HD'];
                for (const res of resOrder) {
                    if (availableQualities.resolutions.has(res)) {
                        qualityInfo.quality = res;
                        break;
                    }
                }
            }
            
            // Dolby Vision
            if (availableQualities.hdr.has('Dolby Vision')) {
                qualityInfo.dv = true;
                qualityInfo.hdr = true;
            }
            
            // HDR - берем максимальный тип
            if (availableQualities.hdr.size > 0) {
                qualityInfo.hdr = true;
                
                const hdrOrder = ['HDR10+', 'HDR10', 'HDR'];
                for (const hdr of hdrOrder) {
                    if (availableQualities.hdr.has(hdr)) {
                        qualityInfo.hdr_type = hdr;
                        break;
                    }
                }
            }
            
            // Аудио - берем только максимальное
            if (availableQualities.audio.size > 0) {
                const audioOrder = ['7.1', '5.1', '4.0', '2.0'];
                for (const audio of audioOrder) {
                    if (availableQualities.audio.has(audio)) {
                        qualityInfo.sound = audio;
                        break;
                    }
                }
            }

            // Сохраняем данные для отображения бейджей
            if (activity && activity.quality_info === undefined) {
                activity.quality_info = qualityInfo;
                // Обновляем бейджи качества
                updateQualityBadges(activity, qualityInfo);
            }
            
        }, (error) => {
            console.log('Quality Badges', { error: error });
        });
    }

    /**
     * Обновляет бейджи качества
     */
    function updateQualityBadges(activity, qualityInfo) {
        const render = activity.render();
        
        // Ищем подходящее место для размещения бейджей
        // Попробуем разные селекторы
        let badgesContainer = render.find('.quality-badges');
        
        // Если контейнера нет, создадим его в подходящем месте
        if (!badgesContainer.length) {
            // Сначала попробуем найти контейнер с мета-информацией
            let metaContainer = render.find('.original-title');
            if (!metaContainer.length) {
                metaContainer = render.find('.full-start-new__details');
            }
            if (!metaContainer.length) {
                metaContainer = render.find('.full-start__body');
            }
            if (!metaContainer.length) {
                metaContainer = render.find('.full-start-new__body');
            }
            
            if (metaContainer.length) {
                metaContainer.append('<div class="quality-badges"></div>');
                badgesContainer = render.find('.quality-badges');
            }
        }
        
        if (!badgesContainer.length) {
            console.log('Не найден контейнер для бейджей качества');
            return;
        }
        
        const badges = [];
        
        // Порядок: Quality, Dolby Vision, HDR, Sound, DUB
        
        // 1. Quality (4K/2K/FHD/HD)
        if (qualityInfo.quality) {
            let qualitySvg = '';
            if (qualityInfo.quality === '4K') {
                qualitySvg = '<svg viewBox="0 0 311 134" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M291 0C302.046 3.57563e-06 311 8.95431 311 20V114C311 125.046 302.046 134 291 134H20C8.95431 134 0 125.046 0 114V20C0 8.95431 8.95431 0 20 0H291ZM113 20.9092L74.1367 82.1367V97.6367H118.818V114H137.637V97.6367H149.182V81.8633H137.637V20.9092H113ZM162.841 20.9092V114H182.522V87.5459L192.204 75.7275L217.704 114H241.25L206.296 62.5908L240.841 20.9092H217.25L183.75 61.9541H182.522V20.9092H162.841ZM119.182 81.8633H93.9541V81.1367L118.454 42.3633H119.182V81.8633Z" fill="white"/></svg>';
            } else if (qualityInfo.quality === '2K') {
                qualitySvg = '<svg viewBox="0 0 311 134" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M291 0C302.046 3.57563e-06 311 8.95431 311 20V114C311 125.046 302.046 134 291 134H20C8.95431 134 0 125.046 0 114V20C0 8.95431 8.95431 0 20 0H291ZM110.608 19.6367C104.124 19.6367 98.3955 20.8638 93.4258 23.3184C88.4563 25.7729 84.5925 29.2428 81.835 33.7275C79.0775 38.2123 77.6992 43.5001 77.6992 49.5908H96.3809C96.3809 46.6212 96.9569 44.0607 98.1084 41.9092C99.2599 39.7578 100.896 38.1056 103.017 36.9541C105.138 35.8026 107.623 35.2275 110.472 35.2275C113.199 35.2276 115.639 35.7724 117.79 36.8633C119.941 37.9238 121.638 39.4542 122.881 41.4541C124.123 43.4238 124.744 45.7727 124.744 48.5C124.744 50.9545 124.244 53.2421 123.244 55.3633C122.244 57.4542 120.774 59.5906 118.835 61.7725C116.926 63.9543 114.562 66.4094 111.744 69.1367L78.6084 99.8184V114H144.972V97.9092H105.881V97.2725L119.472 83.9541C125.865 78.1361 130.82 73.1514 134.335 69C137.85 64.8182 140.29 61.0151 141.653 57.5908C143.047 54.1666 143.744 50.6968 143.744 47.1816C143.744 41.8182 142.366 37.0606 139.608 32.9092C136.851 28.7577 132.986 25.515 128.017 23.1816C123.077 20.8182 117.275 19.6368 110.608 19.6367ZM159.778 20.9092V114H179.46V87.5459L189.142 75.7275L214.642 114H238.188L203.233 62.5908L237.778 20.9092H214.188L180.688 61.9541H179.46V20.9092H159.778Z" fill="white"/></svg>';
            } else if (qualityInfo.quality === 'FULL HD') {
                qualitySvg = '<svg viewBox="331 0 311 134" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M622 0C633.046 3.57563e-06 642 8.95431 642 20V114C642 125.046 633.046 134 622 134H351C339.954 134 331 125.046 331 114V20C331 8.95431 339.954 0 351 0H622ZM362.341 20.9092V114H382.022V75.5459H419.887V59.3184H382.022V37.1367H423.978V20.9092H362.341ZM437.216 20.9092V114H456.897V75.5459H496.853V114H516.488V20.9092H496.853V59.3184H456.897V20.9092H437.216ZM532.716 20.9092V114H565.716C575.17 114 583.291 112.136 590.079 108.409C596.897 104.682 602.125 99.333 605.762 92.3633C609.428 85.3937 611.262 77.0601 611.262 67.3633C611.262 57.6968 609.428 49.3934 605.762 42.4541C602.125 35.5149 596.928 30.1969 590.171 26.5C583.413 22.7727 575.352 20.9092 565.988 20.9092H532.716ZM564.943 37.7725C570.761 37.7725 575.655 38.8027 579.625 40.8633C583.595 42.9239 586.579 46.1364 588.579 50.5C590.609 54.8636 591.625 60.4847 591.625 67.3633C591.625 74.3026 590.609 79.9694 588.579 84.3633C586.579 88.7269 583.579 91.955 579.579 94.0459C575.609 96.1063 570.715 97.1367 564.897 97.1367H552.397V37.7725H564.943Z" fill="white"/></svg>';
            } else if (qualityInfo.quality === 'HD') {
                qualitySvg = '<svg viewBox="662 0 311 134" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M953 0C964.046 3.57563e-06 973 8.95431 973 20V114C973 125.046 964.046 134 953 134H682C670.954 134 662 125.046 662 114V20C662 8.95431 670.954 0 682 0H953ZM731.278 20.9092V114H750.96V75.5459H790.915V114H810.551V20.9092H790.915V59.3184H750.96V20.9092H731.278ZM826.778 20.9092V114H859.778C869.233 114 877.354 112.136 884.142 108.409C890.96 104.682 896.188 99.333 899.824 92.3633C903.491 85.3937 905.324 77.0601 905.324 67.3633C905.324 57.6968 903.491 49.3934 899.824 42.4541C896.188 35.5149 890.991 30.1969 884.233 26.5C877.476 22.7727 869.414 20.9092 860.051 20.9092H826.778ZM859.006 37.7725C864.824 37.7725 869.718 38.8027 873.688 40.8633C877.657 42.9239 880.642 46.1364 882.642 50.5C884.672 54.8636 885.687 60.4847 885.688 67.3633C885.688 74.3026 884.672 79.9694 882.642 84.3633C880.642 88.7269 877.642 91.955 873.642 94.0459C869.672 96.1063 864.778 97.1367 858.96 97.1367H846.46V37.7725H859.006Z" fill="white"/></svg>';
            }
            if (qualitySvg) {
                badges.push(`<div class="quality-badge quality-badge--res">${qualitySvg}</div>`);
            }
        }
        
        // 2. Dolby Vision
        if (qualityInfo.dv) {
            badges.push('<div class="quality-badge quality-badge--dv"><svg viewBox="0 0 1051 393" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0,393) scale(0.1,-0.1)" fill="currentColor"><path d="M50 2905 l0 -1017 223 5 c146 4 244 11 287 21 361 85 638 334 753 677 39 116 50 211 44 366 -7 200 -52 340 -163 511 -130 199 -329 344 -574 419 -79 24 -102 26 -327 31 l-243 4 0 -1017z"/><path d="M2436 3904 c-443 -95 -762 -453 -806 -905 -30 -308 86 -611 320 -832 104 -99 212 -165 345 -213 133 -47 253 -64 468 -64 l177 0 0 1015 0 1015 -217 -1 c-152 0 -239 -5 -287 -15z"/><path d="M3552 2908 l3 -1013 425 0 c309 0 443 4 490 13 213 43 407 148 550 299 119 124 194 255 247 428 25 84 27 103 27 270 1 158 -2 189 -22 259 -72 251 -221 458 -424 590 -97 63 -170 97 -288 134 l-85 26 -463 4 -462 3 2 -1013z m825 701 c165 -22 283 -81 404 -199 227 -223 279 -550 133 -831 -70 -133 -176 -234 -319 -304 -132 -65 -197 -75 -490 -75 l-245 0 0 703 c0 387 3 707 7 710 11 11 425 8 510 -4z"/><path d="M7070 2905 l0 -1015 155 0 155 0 0 1015 0 1015 -155 0 -155 0 0 -1015z"/><path d="M7640 2905 l0 -1015 150 0 150 0 0 60 c0 33 2 60 5 60 2 0 33 -15 67 -34 202 -110 433 -113 648 -9 79 38 108 59 180 132 72 71 95 102 134 181 102 207 102 414 1 625 -120 251 -394 411 -670 391 -115 -8 -225 -42 -307 -93 -21 -13 -42 -23 -48 -23 -7 0 -10 125 -10 370 l0 370 -150 0 -150 0 0 -1015z m832 95 c219 -67 348 -310 280 -527 -62 -198 -268 -328 -466 -295 -96 15 -168 52 -235 119 -131 132 -164 311 -87 478 27 60 101 145 158 181 100 63 234 80 350 44z"/><path d="M6035 3286 c-253 -49 -460 -232 -542 -481 -23 -70 -26 -96 -26 -210 0 -114 3 -140 26 -210 37 -113 90 -198 177 -286 84 -85 170 -138 288 -177 67 -22 94 -26 207 -26 113 0 140 4 207 26 119 39 204 92 288 177 87 89 140 174 177 286 22 67 26 99 27 200 1 137 -14 207 -69 320 -134 277 -457 440 -760 381z m252 -284 c117 -37 206 -114 260 -229 121 -253 -38 -548 -321 -595 -258 -43 -503 183 -483 447 20 271 287 457 544 377z"/><path d="M9059 3258 c10 -24 138 -312 285 -642 l266 -598 -72 -162 c-39 -88 -78 -171 -86 -183 -37 -58 -132 -80 -208 -48 l-35 14 -18 -42 c-10 -23 -37 -84 -60 -135 -23 -52 -39 -97 -36 -102 3 -4 40 -23 83 -41 70 -31 86 -34 177 -34 93 0 105 2 167 33 76 37 149 104 180 166 29 57 799 1777 805 1799 5 16 -6 17 -161 15 l-167 -3 -185 -415 c-102 -228 -192 -431 -200 -450 l-15 -35 -201 453 -201 452 -168 0 -168 0 18 -42z"/><path d="M2650 968 c0 -2 81 -211 179 -463 l179 -460 59 -3 59 -3 178 453 c98 249 180 459 183 466 4 9 -13 12 -65 12 -47 0 -71 -4 -74 -12 -3 -7 -65 -176 -138 -375 -73 -200 -136 -363 -139 -363 -3 0 -67 168 -142 373 l-136 372 -72 3 c-39 2 -71 1 -71 0z"/><path d="M3805 958 c-3 -7 -4 -215 -3 -463 l3 -450 63 -3 62 -3 0 466 0 465 -60 0 c-39 0 -62 -4 -65 -12z"/><path d="M4580 960 c-97 -16 -178 -72 -211 -145 -23 -50 -24 -143 -3 -193 32 -77 91 -117 244 -167 99 -32 146 -64 166 -112 28 -65 -11 -149 -83 -179 -78 -33 -212 -1 -261 61 l-19 24 -48 -43 -48 -42 43 -37 c121 -103 347 -112 462 -17 54 44 88 120 88 194 -1 130 -79 213 -242 256 -24 7 -71 25 -104 41 -48 22 -66 37 -79 65 -32 67 -5 138 65 174 73 37 193 18 244 -39 l20 -22 43 43 c41 40 42 43 25 61 -27 30 -102 64 -167 76 -64 12 -70 12 -135 1z"/><path d="M5320 505 l0 -465 65 0 65 0 0 465 0 465 -65 0 -65 0 0 -465z"/><path d="M6210 960 c-147 -25 -264 -114 -328 -249 -32 -65 -36 -84 -40 -175 -7 -161 33 -271 135 -367 140 -132 360 -164 541 -77 227 108 316 395 198 634 -88 177 -290 271 -506 234z m232 -132 c100 -46 165 -136 188 -261 20 -106 -18 -237 -88 -310 -101 -105 -245 -132 -377 -73 -74 33 -120 79 -157 154 -31 62 -33 74 -33 167 0 87 4 107 26 155 64 137 173 204 320 196 43 -2 85 -12 121 -28z"/><path d="M7135 958 c-3 -7 -4 -215 -3 -463 l3 -450 63 -3 62 -3 0 376 c0 207 3 374 8 371 4 -2 115 -171 247 -375 l240 -371 78 0 77 0 0 465 0 465 -60 0 -60 0 -2 -372 -3 -372 -241 370 -241 369 -82 3 c-59 2 -83 -1 -86 -10z"/></g></svg></div>');
        }
        
        // 3. HDR
        if (qualityInfo.hdr && qualityInfo.hdr_type) {
            badges.push('<div class="quality-badge quality-badge--hdr"><svg viewBox="-1 178 313 136" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="181.5" width="306" height="129" rx="17.5" stroke="currentColor" stroke-width="5" fill="none"/><path d="M27.2784 293V199.909H46.9602V238.318H86.9148V199.909H106.551V293H86.9148V254.545H46.9602V293H27.2784ZM155.778 293H122.778V199.909H156.051C165.415 199.909 173.475 201.773 180.233 205.5C186.991 209.197 192.188 214.515 195.824 221.455C199.491 228.394 201.324 236.697 201.324 246.364C201.324 256.061 199.491 264.394 195.824 271.364C192.188 278.333 186.96 283.682 180.142 287.409C173.354 291.136 165.233 293 155.778 293ZM142.46 276.136H154.96C160.778 276.136 165.672 275.106 169.642 273.045C173.642 270.955 176.642 267.727 178.642 263.364C180.672 258.97 181.688 253.303 181.688 246.364C181.688 239.485 180.672 233.864 178.642 229.5C176.642 225.136 173.657 221.924 169.688 219.864C165.718 217.803 160.824 216.773 155.006 216.773H142.46V276.136ZM215.903 293V199.909H252.631C259.661 199.909 265.661 201.167 270.631 203.682C275.631 206.167 279.434 209.697 282.04 214.273C284.676 218.818 285.994 224.167 285.994 230.318C285.994 236.5 284.661 241.818 281.994 246.273C279.328 250.697 275.464 254.091 270.403 256.455C265.373 258.818 259.282 260 252.131 260H227.54V244.182H248.949C252.706 244.182 255.828 243.667 258.312 242.636C260.797 241.606 262.646 240.061 263.858 238C265.1 235.939 265.722 233.379 265.722 230.318C265.722 227.227 265.1 224.621 263.858 222.5C262.646 220.379 260.782 218.773 258.267 217.682C255.782 216.561 252.646 216 248.858 216H235.585V293H215.903ZM266.176 250.636L289.312 293H267.585L244.949 250.636H266.176Z" fill="currentColor"/></svg></div>');
        }
        
        // 4. Sound (7.1/5.1/2.0)
        if (qualityInfo.sound) {
            let soundSvg = '';
            if (qualityInfo.sound === '7.1') {
                soundSvg = '<svg viewBox="-1 368 313 136" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="371.5" width="306" height="129" rx="17.5" stroke="currentColor" stroke-width="5" fill="none"/><path d="M91.6023 483L130.193 406.636V406H85.2386V389.909H150.557V406.227L111.92 483H91.6023ZM159.545 484.182C156.545 484.182 153.97 483.121 151.818 481C149.697 478.848 148.636 476.273 148.636 473.273C148.636 470.303 149.697 467.758 151.818 465.636C153.97 463.515 156.545 462.455 159.545 462.455C162.455 462.455 165 463.515 167.182 465.636C169.364 467.758 170.455 470.303 170.455 473.273C170.455 475.273 169.939 477.106 168.909 478.773C167.909 480.409 166.591 481.727 164.955 482.727C163.318 483.697 161.515 484.182 159.545 484.182ZM215.045 389.909V483H195.364V408.591H194.818L173.5 421.955V404.5L196.545 389.909H215.045Z" fill="currentColor"/></svg>';
            } else if (qualityInfo.sound === '5.1') {
                soundSvg = '<svg viewBox="330 368 313 136" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="333.5" y="371.5" width="306" height="129" rx="17.5" stroke="currentColor" stroke-width="5" fill="none"/><path d="M443.733 484.273C437.309 484.273 431.581 483.091 426.551 480.727C421.551 478.364 417.581 475.106 414.642 470.955C411.703 466.803 410.172 462.045 410.051 456.682H429.142C429.354 460.288 430.869 463.212 433.688 465.455C436.506 467.697 439.854 468.818 443.733 468.818C446.824 468.818 449.551 468.136 451.915 466.773C454.309 465.379 456.172 463.455 457.506 461C458.869 458.515 459.551 455.667 459.551 452.455C459.551 449.182 458.854 446.303 457.46 443.818C456.097 441.333 454.203 439.394 451.778 438C449.354 436.606 446.581 435.894 443.46 435.864C440.733 435.864 438.081 436.424 435.506 437.545C432.96 438.667 430.975 440.197 429.551 442.136L412.051 439L416.46 389.909H473.369V406H432.688L430.278 429.318H430.824C432.46 427.015 434.93 425.106 438.233 423.591C441.536 422.076 445.233 421.318 449.324 421.318C454.93 421.318 459.93 422.636 464.324 425.273C468.718 427.909 472.188 431.53 474.733 436.136C477.278 440.712 478.536 445.985 478.506 451.955C478.536 458.227 477.081 463.803 474.142 468.682C471.233 473.53 467.157 477.348 461.915 480.136C456.703 482.894 450.642 484.273 443.733 484.273ZM500.733 484.182C497.733 484.182 495.157 483.121 493.006 481C490.884 478.848 489.824 476.273 489.824 473.273C489.824 470.303 490.884 467.758 493.006 465.636C495.157 463.515 497.733 462.455 500.733 462.455C503.642 462.455 506.188 463.515 508.369 465.636C510.551 467.758 511.642 470.303 511.642 473.273C511.642 475.273 511.127 477.106 510.097 478.773C509.097 480.409 507.778 481.727 506.142 482.727C504.506 483.697 502.703 484.182 500.733 484.182ZM556.233 389.909V483H536.551V408.591H536.006L514.688 421.955V404.5L537.733 389.909H556.233Z" fill="currentColor"/></svg>';
            } else if (qualityInfo.sound === '2.0') {
                soundSvg = '<svg viewBox="661 368 313 136" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="664.5" y="371.5" width="306" height="129" rx="17.5" stroke="currentColor" stroke-width="5" fill="none"/><path d="M722.983 483V468.818L756.119 438.136C758.938 435.409 761.301 432.955 763.21 430.773C765.15 428.591 766.619 426.455 767.619 424.364C768.619 422.242 769.119 419.955 769.119 417.5C769.119 414.773 768.498 412.424 767.256 410.455C766.013 408.455 764.316 406.924 762.165 405.864C760.013 404.773 757.574 404.227 754.847 404.227C751.998 404.227 749.513 404.803 747.392 405.955C745.271 407.106 743.634 408.758 742.483 410.909C741.331 413.061 740.756 415.621 740.756 418.591H722.074C722.074 412.5 723.453 407.212 726.21 402.727C728.968 398.242 732.831 394.773 737.801 392.318C742.771 389.864 748.498 388.636 754.983 388.636C761.65 388.636 767.453 389.818 772.392 392.182C777.362 394.515 781.225 397.758 783.983 401.909C786.741 406.061 788.119 410.818 788.119 416.182C788.119 419.697 787.422 423.167 786.028 426.591C784.665 430.015 782.225 433.818 778.71 438C775.195 442.152 770.241 447.136 763.847 452.955L750.256 466.273V466.909H789.347V483H722.983ZM815.108 484.182C812.108 484.182 809.532 483.121 807.381 481C805.259 478.848 804.199 476.273 804.199 473.273C804.199 470.303 805.259 467.758 807.381 465.636C809.532 463.515 812.108 462.455 815.108 462.455C818.017 462.455 820.563 463.515 822.744 465.636C824.926 467.758 826.017 470.303 826.017 473.273C826.017 475.273 825.502 477.106 824.472 478.773C823.472 480.409 822.153 481.727 820.517 482.727C818.881 483.697 817.078 484.182 815.108 484.182ZM874.483 485.045C866.665 485.015 859.938 483.091 854.301 479.273C848.695 475.455 844.377 469.924 841.347 462.682C838.347 455.439 836.862 446.727 836.892 436.545C836.892 426.394 838.392 417.742 841.392 410.591C844.422 403.439 848.741 398 854.347 394.273C859.983 390.515 866.695 388.636 874.483 388.636C882.271 388.636 888.968 390.515 894.574 394.273C900.21 398.03 904.544 403.485 907.574 410.636C910.604 417.758 912.104 426.394 912.074 436.545C912.074 446.758 910.559 455.485 907.528 462.727C904.528 469.97 900.225 475.5 894.619 479.318C889.013 483.136 882.301 485.045 874.483 485.045ZM874.483 468.727C879.816 468.727 884.074 466.045 887.256 460.682C890.438 455.318 892.013 447.273 891.983 436.545C891.983 429.485 891.256 423.606 889.801 418.909C888.377 414.212 886.347 410.682 883.71 408.318C881.104 405.955 878.028 404.773 874.483 404.773C869.18 404.773 864.938 407.424 861.756 412.727C858.574 418.03 856.968 425.97 856.938 436.545C856.938 443.697 857.65 449.667 859.074 454.455C860.528 459.212 862.574 462.788 865.21 465.182C867.847 467.545 870.938 468.727 874.483 468.727Z" fill="currentColor"/></svg>';
            }
            if (soundSvg) {
                badges.push(`<div class="quality-badge quality-badge--sound">${soundSvg}</div>`);
            }
        }
        
        // 5. DUB
        if (qualityInfo.dub) {
            badges.push('<div class="quality-badge quality-badge--dub"><svg viewBox="-1 558 313 136" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="561.5" width="306" height="129" rx="17.5" stroke="currentColor" stroke-width="5" fill="none"/><path d="M60.5284 673H27.5284V579.909H60.8011C70.1648 579.909 78.2254 581.773 84.983 585.5C91.7405 589.197 96.9375 594.515 100.574 601.455C104.241 608.394 106.074 616.697 106.074 626.364C106.074 636.061 104.241 644.394 100.574 651.364C96.9375 658.333 91.7102 663.682 84.892 667.409C78.1042 671.136 69.983 673 60.5284 673ZM47.2102 656.136H59.7102C65.5284 656.136 70.4223 655.106 74.392 653.045C78.392 650.955 81.392 647.727 83.392 643.364C85.4223 638.97 86.4375 633.303 86.4375 626.364C86.4375 619.485 85.4223 613.864 83.392 609.5C81.392 605.136 78.4072 601.924 74.4375 599.864C70.4678 597.803 65.5739 596.773 59.7557 596.773H47.2102V656.136ZM178.153 579.909H197.835V640.364C197.835 647.152 196.214 653.091 192.972 658.182C189.759 663.273 185.259 667.242 179.472 670.091C173.684 672.909 166.941 674.318 159.244 674.318C151.517 674.318 144.759 672.909 138.972 670.091C133.184 667.242 128.684 663.273 125.472 658.182C122.259 653.091 120.653 647.152 120.653 640.364V579.909H140.335V638.682C140.335 642.227 141.108 645.379 142.653 648.136C144.229 650.894 146.441 653.061 149.29 654.636C152.138 656.212 155.456 657 159.244 657C163.063 657 166.381 656.212 169.199 654.636C172.047 653.061 174.244 650.894 175.79 648.136C177.366 645.379 178.153 642.227 178.153 638.682V579.909ZM214.028 673V579.909H251.301C258.15 579.909 263.862 580.924 268.438 582.955C273.013 584.985 276.453 587.803 278.756 591.409C281.059 594.985 282.21 599.106 282.21 603.773C282.21 607.409 281.483 610.606 280.028 613.364C278.574 616.091 276.574 618.333 274.028 620.091C271.513 621.818 268.634 623.045 265.392 623.773V624.682C268.938 624.833 272.256 625.833 275.347 627.682C278.468 629.53 280.998 632.121 282.938 635.455C284.877 638.758 285.847 642.697 285.847 647.273C285.847 652.212 284.619 656.621 282.165 660.5C279.741 664.348 276.15 667.394 271.392 669.636C266.634 671.879 260.771 673 253.801 673H214.028ZM233.71 656.909H249.756C255.241 656.909 259.241 655.864 261.756 653.773C264.271 651.652 265.528 648.833 265.528 645.318C265.528 642.742 264.907 640.47 263.665 638.5C262.422 636.53 260.65 634.985 258.347 633.864C256.074 632.742 253.362 632.182 250.21 632.182H233.71V656.909ZM233.71 618.864H248.301C250.998 618.864 253.392 618.394 255.483 617.455C257.604 616.485 259.271 615.121 260.483 613.364C261.725 611.606 262.347 609.5 262.347 607.045C262.347 603.682 261.15 600.97 258.756 598.909C256.392 596.848 253.028 595.818 248.665 595.818H233.71V618.864Z" fill="currentColor"/></svg></div>');
        }
        
        if (badges.length > 0) {
            badgesContainer.html(badges.join(''));
            badgesContainer.addClass('show');
        }
    }

    /**
     * Добавляет CSS стили
     */
    function addStyles() {
        const styles = `<style>
        /* Бейджи качества */
        .quality-badges {
            display: inline-flex;
            align-items: center;
            gap: 0.4em;
            margin-left: 0.6em;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .quality-badges.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .quality-badge {
            display: inline-flex;
            height: 0.8em;
        }
        
        .quality-badge svg {
            height: 100%;
            width: auto;
            display: block;
        }
        
        .quality-badge--res svg {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }
        
        .quality-badge--dv svg,
        .quality-badge--hdr svg,
        .quality-badge--sound svg,
        .quality-badge--dub svg {
            color: rgba(255, 255, 255, 0.85);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }
        </style>`;
        
        // Добавляем стили в DOM
        if (!$('style[data-id="quality-badges"]').length) {
            $(styles).attr('data-id', 'quality-badges').appendTo('head');
        }
    }

    /**
     * Инициализация плагина
     */
    function initializePlugin() {
        console.log('Quality Badges loaded');
        
        // Добавляем стили
        addStyles();
        
        // Добавляем слушатель для карточки фильма
        Lampa.Listener.follow('full', (event) => {
            if (event.type === 'complite') {
                const activity = event.object.activity;
                const render = activity.render();
                const data = event.data && event.data.movie;
                
                // Добавляем контейнер для бейджей качества
                let badgesContainer = render.find('.quality-badges');
                
                if (!badgesContainer.length) {
                    // Ищем подходящее место для размещения бейджей
                    let metaContainer = render.find('.original-title');
                    if (!metaContainer.length) {
                        metaContainer = render.find('.full-start-new__details');
                    }
                    if (!metaContainer.length) {
                        metaContainer = render.find('.full-start__body');
                    }
                    if (!metaContainer.length) {
                        metaContainer = render.find('.full-start-new__body');
                    }
                    if (!metaContainer.length) {
                        metaContainer = render.find('.full-start__head');
                    }
                    if (!metaContainer.length) {
                        metaContainer = render.find('.full-start-new__head');
                    }
                    
                    if (metaContainer.length) {
                        metaContainer.append('<div class="quality-badges"></div>');
                        badgesContainer = render.find('.quality-badges');
                    }
                }
                
                // Анализируем качество контента
                if (data && badgesContainer.length) {
                    analyzeContentQualities(data, activity);
                }
            }
        });
    }

    // Унифицированный запуск плагина
    (function initAllPlugins() {
        // Запуск основного плагина рейтингов
        if (!window.maxsmRatingsPlugin) startPlugin();
        
        // Запуск плагина бейджей качества
        if (window.appready) {
            initializePlugin();
        } else {
            Lampa.Listener.follow('app', (event) => {
                if (event.type === 'ready') {
                    initializePlugin();
                }
            });
        }
    })();
})();
